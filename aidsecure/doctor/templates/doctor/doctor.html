{% extends "portal/base.html" %}
{% load static %}
{% block content %}
<!-- <meta name="viewport" content="width=device-width, initial-scale=1"> -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">


<meta charset="utf-8" />
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>

<!-- js to pdf for downloading forms -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/0.4.1/html2canvas.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.0.272/jspdf.debug.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.2/jspdf.min.js"></script>

<!-- STATISTICAL DATA not that useful tho--> 
<meta charset="utf-8" />
<link rel="apple-touch-icon" sizes="76x76" href=" {% static 'doctor/assets/img/apple-icon.png' %} ">
<link rel="icon" type="image/png" href="{% static 'doctor/assets/img/favicon.png' %}">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, shrink-to-fit=no' name='viewport' />

<!--     Fonts and icons     -->
<link href="https://fonts.googleapis.com/css?family=Montserrat:400,700,200" rel="stylesheet" />
<link href="https://maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css" rel="stylesheet">
<!-- CSS Files -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

<!-- seen icon eyes -->
<script src='https://kit.fontawesome.com/a076d05399.js'></script>


<!-- stats -->
<script src="https://canvasjs.com/assets/script/canvasjs.min.js"> </script>


<!-- script for downloading tabular data (plugin) -->
<script src="{% static 'cebuMap/js/jspdf.plugin.autotable.js'%}"></script>
<script src="{% static 'cebuMap/js/jspdf.plugin.autotable.min.js'%}"></script> 

<!-- search new patient present address -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css" /> 
<script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"></script>
<script src= "https://maps.googleapis.com/maps/api/js?key=AIzaSyBVWaKrjvy3MaE7SQ74_uJiULgl1JY0H2s&sensor=false"></script>




<!-- END OF UI FOR STATISTICAL DATA -->

<style>
   /*--for sizing of the app to relatively resize depending on the size of the screen */
   /* On screens that are 992px wide or less, the background color is blue */
/*@media screen and (max-width: 992px) {
  body {
    background-color: blue;
    color: white;
  }
}*/

/* On screens that are 600px wide or less, the background color is olive */
/*@media screen and (max-width: 600px) {
  body {
    background-color: olive;
    color: white;
  }
}*/
   /* end */
   .notif-bar:hover{
      box-shadow: 10px 10px 5px -8px rgba(0,0,0,0.75);
   }

   .dot {
      height: 5px;
      width: 5px;
      background-color: #bbb;
      border-radius: 50%;
      display: inline-block;
   }

      .collapsible {
        background-color: white;
        border:1px solid rgba(0, 0, 0, 0.125);
        cursor: pointer;
        padding: 18px;
        width: 100%;
        text-align: left;
        outline: none;
        font-size: 15px;
      }
      
      .collapsible:hover{
         color:white;
         background-color: #800000;
      }
      
      .collapsible:visited{
         color:white;
         background-color: #800000;
      }

   
      .content {
        padding: 0 18px;
        display: none;
        overflow: hidden;
        border:1px solid  #800000;
        /* background-color: #f1f1f1; */
      }

      .close {
      /* cursor: pointer; */
      position: absolute;
      right:35px;
      padding-top:3%;
      /* padding: 25px 20px; */
      transform: translate(-50%);
      /* float: right; */
      }
      .close:hover{
         color:#800000;
      }


      .dropbtn {
         right:20%;
      /* padding: 20px; */
      font-size: 16px;
      border: none;
      cursor: pointer;
      background: transparent;
      }

      .dropdown {
      position: relative;
      display: inline-block;
      }

      .dropdown-content {
      display: none;
      position: absolute;
      min-width: 160px;
      z-index: 1;
      }

      .dropdown-content a {
      color: black;
      padding: 12px 16px;
      text-decoration: none;
      display: block;
      }

      .dropdown-content a:hover {background-color: rgba(0, 0, 0, 0.125);}

      .dropdown:hover .dropdown-content {
      display: block;
      }

      .dropdown:hover .dropbtn { 
      background-color:transparent;
      }

      .menu-content{
         font-size:small;
         font-color:black;
      }
      .fa:hover{
         color:#800000;
      }
      /* FOR STATISTICAL DATA */
      .numbers{
         font-style: initial;
      }
       
       /* chart legend colors */
      /* basic positioning */
      .legend { list-style: none; }
      .legend li { float: left; margin-right: 10px; }
      .legend span { border: 1px solid #ccc; float: left; width: 12px; height: 12px; margin: 2px; }
      /* your colors */
      .legend .superawesome { background-color: #ff00ff; }
      .legend .awesome { background-color: #00ffff; }
      .legend .kindaawesome { background-color: #0000ff; }

      /* FOR NOTIFICATION */
      .card.card-plain{
         background-color: transparent;
         box-shadow: none;
         border-radius: 0;
         border-color: transparent;
      }

      /* FOR PATIENTS */
      .btn:active{
         background-color:#800000;
      }

      /* for patient field - change tab to view details */
      
/* Style the tab */
.patient-details-tab {
  overflow: hidden;
  border: 1px solid #ccc;
  background-color: #f1f1f1;
}

/* Style the buttons inside the tab */
.patient-details-tab button {
  background-color: inherit;
  float: left;
  border: none;
  outline: none;
  cursor: pointer;
  padding: 10px 14px;
  transition: 0.3s;
  font-size: 13px;
}

/* Change background color of buttons on hover */
.patient-details-tab button:hover {
  background-color: #ddd;
}

/* Create an active/current tablink class */
.patient-details-tab button.active {
   color:white;
   background-color: #800000;
}

/* Style the tab content */
.patient-tab-content {
  display: none;
  padding: 6px 0px;
  border: 1px solid #ccc;
  border-top: none;
}
/* end of tabs for patients */
.p-record-par{
   margin-left:1rem;
   margin-right:1rem;
   margin-bottom:0;
}

.post-title:hover{
   background-color:#800000;
   color:#ddd;
}
.post-title:active{
   background-color:#800000;
   color:#ddd;
}

.record-active{
   background-color:#800000;
   color:#ddd;
}

.patient-content{
   margin-left:1rem;
   margin-right:1rem;
}

#comments-section{
   padding:3px 12px;
   border: 1px solid #ccc;
}

p{
   margin-left:1rem;
}


.card.card-plain{
   background-color: transparent;
   box-shadow: none;
   border-radius: 10%;
   border-color: transparent;
}
.card-header{
   background-color:rgba(0, 0, 0, 0.125);
}
.card-body{
   background-color:rgba(0, 0, 0, 0.03);
}
.doc-remarks-header{
   padding-left: 1rem;
    margin-bottom: 0px;
    background-color: rgb(0,0,0,0.03);
    margin-top: 0px;
    padding-top: .4rem;
    padding-bottom: .4rem;
    margin-left: 0px;
}


#notification {
  background: #800000;
  color: white;
  text-decoration: none;
  /* padding: 15px 26px; */
  position: relative;
  display: inline-block;
  border: solid;
  /* border-style:ridge */
  /* border-radius: 2px; */
}

#notification:hover {
  background: white;
  color:#800000;
}

#notification .badge {
  position: absolute;
  top: -10px;
  right: -10px;
  padding: 5px 10px;
  border-radius: 50%;
  background: red;
  color: white;
}
#log-out-doc{
   font-family:"Roboto", Arial, sans-serif;
}
#log-out-doc:hover{
   background: white;
   color:#800000;
   border: solid;
} #comm:hover{
   background: white;
   color:#800000;
   border: solid; 
}

#patient-profile-basic-info p{
   margin-bottom:0rem;
}

/* profile picture change setting */
.change-prof-pic-wrapper, .patient-pic{
   width: 200px;
   height: 200px;
   overflow: hidden;                       
}

.change-prof-pic-wrapper, .patient-pic img {
   object-fit: contain;
   height:250px;
   width:100%;
}

/* profile picture setting */
.prof-pic{
   max-width: 100%;
   max-height: 100%;
}

/* profile picture setting */
.prof-pic{
   max-width: 100%;
   max-height: 100%;
}

#userpic{
   display: inline-block;
   width: 150px;
   height: 150px;
   border-radius: 50%;
   border:2px solid whitesmoke;
   object-fit: cover;
   margin:0px;
}

#userpic:hover{
   opacity: 0.5;
   border:2px solid whitesmoke;
   margin:0px;
}

#userpic-wrapper{
   margin:1rem;
   display: inline-block;
   width: 155px;
   height: 155px;
   border-radius: 50%;
   border:2px solid whitesmoke;
   background:white;

}


/* new patient pic setting */
#notif-new-patient-pic{
   margin-top:0.5rem;
   object-fit:cover;
   height:150px;
   width: 35%;
   margin-left: 9.5rem;
   border-radius: 50%;
}

/* for stats */
.canvasjs-chart-credit{
   display:none;
}
.canvasjs-chart-canvas{
 /*  height:230px;
   width:728px;*/
   position:relative;
}

/* patients profile info */
.patient-info{
   width: 200px;
   float: left;
}
.patient-pic{
   margin-left:0.5rem;
   width: 200px;
   float: left;
   height: 300px;
   border:2px solid #800000;
   background-color: antiquewhite;
}

/* to avoid floating divs to mess around */
#clear {
    clear: both;
}


</style>

   <nav class="navbar navbar-expand-lg navbar-dark ftco_navbar bg-dark ftco-navbar-light" id="ftco-navbar" style="background:white;">
      <div class="container">
         <a class="navbar-brand" href="{%url 'portal' %}"><img src= "{% static 'portal/images/logo-main.png' %}" id="mainLogo" style="height:60px;"  alt=""></a>
         <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#ftco-nav" aria-controls="ftco-nav" aria-expanded="false" aria-label="Toggle navigation">
         <span class="oi oi-menu"></span> Menu
         </button>
         <a id="menuButton" title="Open Menu" class="w3-dropdown-click w3-button w3-bar-item topnav-icons fa fa-menu" style="font-size:28px;margin-top:-2px"></a>
         <ul class="navbar-nav ml-auto">
            <li  class="nav-item cta" data-toggle="collapse" data-target="#demo">
               <a id="notification"><i style="font-size:24px" class="fa">&#xf0f3;</i><span class="badge">{{doctor.new_notifs.count}}</span></a>
               <div  class="collapse" style="z-index:1;position: absolute;min-width: 160px; border: 1px solid lightgray; background-color: lavenderblush; border-radius:10px;" id="demo">
                  {% for notif in doctor.new_notifs.all %}
                     <hr style="margin-top:0rem; margin-bottom:0rem;">
                     
                     <p style="font-size: 14px; margin-bottom:0rem;">{{notif.notif}}</p>
                  {% endfor %}
               </div>
            </li>
            <li class="nav-item cta"><a  id="log-out-doc" href="{% url 'docLogout' %}"  class="nav-link">Log Out</a></li>
         </ul>
      </div>
   </nav>
   <!-- END nav -->

   <div class="container portal-box">
      <div class="row">

            <div class="col-md-3 left-portal" style="font-family:Roboto, Arial, sans-serif;">
               <div id="userpic-wrapper">
                  {% if not doctor.doc_image  %}
                  <img src="{% static 'portal/images/user.png' %}" id="userpic" alt="user profile picture"  data-toggle="modal" data-target="#change-prof-pic"> 

                  {% endif %}
                  {% if doctor.doc_image.url is not None %}
                     <img src="{{doctor.doc_image.url}}" id="userpic" alt="user profile picture"  data-toggle="modal" data-target="#change-prof-pic"> 
                  {% endif%}
               </div>
               <p id="doc-name" class="white center bold" style="text-transform:uppercase; font-size: 14px;">{{doctor.name}}</p>
               <p id="doc-basic-info" class="white center">{{doctor.position}}</p>
               <p id="doc-basic-info" class="white center" style="text-transform:uppercase; font-size: 12px;">{{doctor.hospital_name}}</p>
               <section class="ftco-services">
                  <div class="list-group">
                     <div class="nav flex-column nav-pills" id="v-pills-master-tab" role="tablist" aria-orientation="vertical">
                        <a class="list-group-item active" id="notifs-tab" data-toggle="pill" href="#notifs" role="tab" aria-controls="v-pills-fitness" aria-selected="false">Notifications</a>
                        <a class="list-group-item" id="stats-tab" data-toggle="pill" href="#stats" role="tab" aria-controls="v-pills-fitness" aria-selected="false">Patients Handled Statistics</a>
                        <a class="list-group-item" id="patients-tab" data-toggle="pill" href="#patients" role="tab" aria-controls="v-pills-fitness" aria-selected="false">Patients List</a>
                        <a class="list-group-item" id="schedules-tab" data-toggle="pill" href="#schedules" role="tab" aria-controls="v-pills-fitness" aria-selected="false">Appointments</a>
                     </div>
                  </div>
               </section>
            </div>
         
             <!-- modal for adding a pending sched remark -->
             <div class="modal fade" id="change-prof-pic" tabindex="-1" role="dialog" aria-hidden="true">
               <div class="modal-dialog" role="document">
                  <div class="modal-content" id="modal-content-{{forloop.counter}}">
                     <div class="modal-header" style="background-color: #802400;">
                        <h5 class="modal-title" id="modal-title-{{schedule.patient_username}}" style="color:#ffffff;"> Change Profile Picture</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                           <span aria-hidden="true" style="color:#ffffff;">&times;</span>
                        </button>
                     </div>

                     <form method="post"  enctype="multipart/form-data">
                        {% csrf_token %}

                        <div class="modal-body"  style="font-size:12px; padding:2rem; max-height: calc(100vh - 210px);overflow-y: auto;">
                           <div class="change-prof-pic-wrapper" style="height:100%; width:100%; background-color: black; text-align:center;">
                              {% if doctor.doc_image %}
                                 <img src="{{doctor.doc_image.url}}" id="prof-pic-preview" style="max-width: 100%; max-height: 300px;" > 
                              {% endif %}
                              {% if not doctor.doc_image %}
                                 <img src="{% static 'portal/images/user.png' %}" id="prof-pic-preview" name="prof-pic-preview"  style=" max-width: 100%; max-height: 300px;" > 
                              {% endif%}
                           </div>
                           
                           <div  style="margin:1.5rem; margin-left: 7.5rem;text-align: center;"> 
                              <input type="file" id="new-prof-pic" name="new-prof-pic" onchange="PreviewImage();"/> 
                           </div> 
                        </div>
                        <div class="modal-footer">
                           <input id="change-prof-pic-upload"  class="btn btn-primary" type="submit" data-dismiss="modal" value="Finish" readonly>
                           <button id="change-prof-pic-back" class="btn btn-primary" type="button" data-dismiss="modal">Back</button>                           
                        </div>
                     </form>
                  </div>
               </div>
            </div>

            <div class="col-md-9 right-portal" style="padding-bottom:500px;">            
            <div class="tab-content pl-md-5" id="v-pills-tabContent" >
               <!-- Doctor Schedules Tab -->
               <div class="tab-pane fade py-5" id="schedules" role="tabpanel" aria-labelledby="v-pills-fitness-tab">
                  <div class="col-md-12" style="border-style: ridge;"> 
                     <div class="card card-plain"  style="padding-top: 1.5rem;">
                        <div class="card-header" style="border:1px solid rgba(0, 0, 0, 0.125);">
                           <h4 class="card-title">Appointments</h4>
                        </div>
                        <div class="card-body" style="margin-bottom: 1rem;">
                           <div class="patient-details-tab" id="{{patient.first_name}}-tab" >
                              <button style="font-size:medium;"  class="tablinks active" id="pending-scheds-btn" onclick="openDetails(event, 'pending-scheds')">Pending</button>
                              <button style="font-size:medium;" class="tablinks" id="ongoing-scheds-btn" onclick="openDetails(event, 'ongoing-scheds')">Scheduled </button>
                              <button style="font-size:medium;" class="tablinks" id="finished-scheds-btn" onclick="openDetails(event, 'finished-scheds')">Finished</button>
                              <button style="font-size:medium;" class="tablinks" id="rejected-scheds-btn" onclick="openDetails(event, 'rejected-scheds')">Declined</button>
                           </div>
                           
                           <!-- PENDING SCHEDULES -->
                           <div class="patient-tab-content" id="pending-scheds">
                              {% for schedule in doctor.pending_scheds.all %}
                              <form id="pending-form-{{forloop.counter}}"  method="post">
                                 {% csrf_token %}
                                 <input hidden id="pending-sched-patient-username-{{forloop.counter}}" name="pending-sched-patient-username" value="{{schedule.patient_username}}">
                                 <input hidden id="pending-sched-topic-{{forloop.counter}}" name="pending-sched-topic" value="{{schedule.schedule_topic}}">
                                 <input hidden id="pending-sched-pk-{{forloop.counter}}" name="pending-sched-pk" value="{{schedule.pk}}">

                                 <input class="collapsible" style="padding:10px; border-bottom:none;" id="pending-patient-uname-{{forloop.counter}}" name="pending-patient-username" readonly value="{{forloop.counter}}. {{schedule.patient_username}}">
                                 
                                 <div class="content"  style="font-size: 12px; border-radius:10px;" id="sched-content-{{forloop.counter}}">
                                    <p id="created-date-{{forloop.counter}}">{{schedule.created_on}}</p>
                                    <p  id="pending-patient-hiv-status-{{forloop.counter}}" name="pending-patient-hiv-status">
                                       <b>HIV Status: </b> {{schedule.patient_hiv_status}}
                                    </p>
                                    <p id="par1-{{forloop.counter}}">
                                       <b>Consultation Date: </b>
                                       <a id="pending-patient-sched-date-{{forloop.counter}}" name="pending-patient-sched-date"> {{schedule.schedule_date}}</a>
                                    </p>
                                    <p id="par2-{{forloop.counter}}">
                                       <b>Consultation Topic:</b>
                                       <a id="pending-patient-sched-topic-{{forloop.counter}}" name="pending-patient-sched-topic">{{schedule.schedule_topic}}</a>
                                    </p>
                                    <p id="par3-{{forloop.counter}}" style="margin-bottom:0rem;">
                                       <b>Patient Consultation details: </b>
                                    </p>
                                    <textarea readonly style="margin-left:1rem;margin-top:0.5rem;"cols="50" rows="4" id="pending-patient-sched-notes-{{forloop.counter}}" name="pending-patient-sched-notes" readonly>{{schedule.schedule_notes}}</textarea>
                                    
                                    <p style= "margin-bottom:0px; font-size: 12px; color:grey;">seen by: 
                                       {% for viewer in schedule.users_viewed.all %}
                                          {{viewer.viewer_name}} |
                                       {% empty %}
                                       ...
                                       {% endfor %}
                                    </p>
                                    
                                    <hr style="border-top: 2px solid rgba(0, 0, 0, 0.1); margin-top:.5rem; margin-bottom:0px;">  
                                    <p class="doc-remarks-header"><b>Doctor(s) Remarks: </b></p>

                                    <hr style="margin-top:0.5rem;">
                                    <input style="margin-left:1rem;" type="button" value="Add a Remark" data-toggle="modal" data-target="#add-remark-modal-{{schedule.pk}}">
                                    
                                    <div id="pending-remarks">
                                       {% for remark in schedule.doc_remark.all %}
                                          <hr style="margin:0rem 0rem;">
                                          <div style="margin-left:1rem; margin-bottom:0rem;">
                                             {% if remark.remark_seen == True %}
                                             <i style='font-size:12px' class='fas'>&#xf06e;</i>
                                             {% else %}
                                             <i style='font-size:12px' class='fas'>&#xf070;</i>
                                             {% endif %}
                                             <b>Dr.{{remark.author}}:</b>{{remark.text}}
                                          </div>
                                       {% empty %}
                                          <hr style="margin:0rem 0rem;">
                                          <p>No remarks yet..</p>
                                       {% endfor%}
                                    </div>
                                    
                                    <hr style="margin:0rem;">                                    
                                    <div class="form-group" style="margin-bottom:3px; margin-left:1rem;" id="btn-options-{{forloop.counter}}" >
                                       <button hidden class="btn btn-primary"  type="submit" id="accept-btn-{{forloop.counter}}" style="font-size: 12px;">Accept</button>
                                       <button class="btn btn-primary"  type="button" id="accept-btn-{{forloop.counter}}" style="font-size: 12px;">Accept</button>
                                       <button class="btn btn-primary" type="button" id="attempt-reject-btn-{{forloop.counter}}" style="font-size: 12px;"  id="reject-button" data-toggle="modal" data-target="#reject-sched-{{schedule.pk}}">Decline</button>
                                    </div>
                                 </div>  
                              </form>

                              <script>
                                 $('#attempt-reject-btn-{{forloop.counter}}').click(function(){
                                    console.log("attempt rejection.");
                                 });
                                 $('#accept-btn-{{forloop.counter}}').click(function(e){
                                    console.log("pending schedule!");
                                    e.preventDefault();
                                                                                       
                                    $.ajax({
                                       type:"POST",
                                       async:true,
                                       url:'/acceptsched/',
                                       data:{
                                          csrfmiddlewaretoken: '{{ csrf_token }}',
                                          p_sched_uname: $('#pending-sched-patient-username-{{forloop.counter}}').val(),
                                          p_sched_topic: $('#pending-sched-topic-{{forloop.counter}}').val(),
                                          p_sched_pk: $('#pending-sched-pk-{{forloop.counter}}').val()
                                       },
                                       success:function(){
                                          alert("Consultation Schedule marked accepted. Refresh to view the changes.")
                                          console.log("pending accepted!!");

                                       }
                                    });
                                 });
                                    
                              </script>

                              <!-- modal for adding a pending sched remark -->
                              <div class="modal fade" id="add-remark-modal-{{schedule.pk}}" tabindex="-1" role="dialog" aria-hidden="true">
                                 <div class="modal-dialog" role="document">
                                    <div class="modal-content" id="modal-content-{{schedule.patient_username}}">
                                       <div class="modal-header" style="background-color: #802400;">
                                          <h5 class="modal-title" id="modal-title-{{schedule.patient_username}}" style="color:#ffffff;">Add a Remark</h5>
                                          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                             <span aria-hidden="true" style="color:#ffffff;">&times;</span>
                                          </button>
                                       </div>
                                       <div class="modal-body"  style="font-size:12px;">
                                          <form id="add-remark-{{forloop.counter}}" method="post">
                                             {% csrf_token %}
                                             <input hidden id="remark_type_{{forloop.counter}}" name="remark_type" value="pending">
                                             <input hidden id="remark_parent_pk_{{forloop.counter}}" name="remark_parent_pk" value="{{schedule.pk}}">
                                             <input hidden id="parent_pusername_{{forloop.counter}}" name="parent_pusername" value="{{schedule.patient_username}}">
                                  
                                             <textarea cols="50" rows="4" id="pending-sched-remark-{{forloop.counter}}" name="sched-remark"></textarea>
                                             
                                             <div class="form-group">
                                                <button class="btn btn-primary"   style="font-size: 12px;" id="submit-pending-remark-{{forloop.counter}}" data-dismiss="modal">Done</button>
                                                <button class="btn btn-primary"  type="button" style="font-size: 12px;" data-dismiss="modal">Go Back</button>
                                             </div>
                                          </form>
                                          <script>
                                             $('#submit-pending-remark-{{forloop.counter}}').click(function(e){
                                                console.log("pending schedule!");
                                                                                                
                                                $.ajax({
                                                   type:"POST",
                                                   async:true,
                                                   url:'/addRemark/',
                                                   data:{
                                                      csrfmiddlewaretoken: '{{ csrf_token }}',
                                                      p_sched_uname: $('#parent_pusername_{{forloop.counter}}').val(),
                                                      p_sched_remark: $('#pending-sched-remark-{{forloop.counter}}').val(),
                                                      p_sched_pk: $('#remark_parent_pk_{{forloop.counter}}').val(),
                                                      remark_type: $('#remark_type_{{forloop.counter}}').val()
                                                   },
                                                   success:function(){
                                                      alert("successfully added a remark!")
                                                      console.log("added a remark successful!!");
                                                      remark = $('#pending-sched-remark-{{forloop.counter}}');
                                                      $('#pending-remarks').append(
                                                         '<hr style="margin-left:1rem; margin:0rem 0rem;">' +
                                                         '<i style="margin-left:1rem;font-size:12px" class="fas">'+ '&#xf070;' + '</i>' +
                                                         '<b>' + ' {{doctor.name}}' + ':' + '</b>' + remark.val() 
                                                         
                                                      );
                                                      remark.val("");
                                                      console.log("remark added to UI too.");
                                                   }
                                                });
                                             });
                                         
                                          </script>
                                       </div>
                                    </div>
                                 </div>
                              </div>
                              <!-- end for adding a pending sched remark -->

                              <!-- REJECT SCHED  -->
                              <div class="modal fade" id="reject-sched-{{schedule.pk}}" tabindex="-1" role="dialog" aria-hidden="true">
                                 <div class="modal-dialog" role="document">
                                    <div class="modal-content" id="modal-content-{{schedule.patient_username}}">
                                       <div class="modal-header" style="background-color: #802400;">
                                          <h5 class="modal-title" id="modal-title-{{schedule.patient_username}}" style="color:#ffffff;"> Confirmation</h5>
                                          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                             <span aria-hidden="true" style="color:#ffffff;">&times;</span>
                                          </button>
                                       </div>
                                       <form id="{{forloop.counter}}" method="post">
                                          <div class="modal-body"  style="font-size:12px;">
                                                {% csrf_token %}
                                                <input hidden id="reject-patient-name-{{forloop.counter}}" name="reject-sched-patient-username" value="{{schedule.patient_username}}">
                                                <input hidden id="reject-topic-{{forloop.counter}}" name="reject-sched-topic" value="{{schedule.schedule_topic}}">
                                                <input hidden id="reject-created-on-{{forloop.counter}}" name="reject-sched-created-on" value="{{schedule.created_on}}">                                                
                                                <input hidden id="reject-pk-{{forloop.counter}}" name="reject-sched-pk" value="{{schedule.pk}}">                                                                                               
                                                <p style="font-size: 15px; color: #802400;">Are you sure to reject the requested consultation?  It will be added to declined consultation list. </p>
                                                <label><b>Possible Remarks:</b></label>
                                                   <div id="doc-remarks">
                                                      <ul style="list-style-type: none;">
                                                         <li><input type="checkbox" name="pos-remark" value="out of time"/>out of time</li>
                                                         <li><input type="checkbox" name="pos-remark" value="in a meeting"/>in a meeting</li>
                                                         <li><input type="checkbox" name="pos-remark" value="prior appointment"/>prior appointment</li>
                                                         <li><input type="checkbox" name="pos-remark" value="not feeling well"/>not feeling well</li>
                                                      </ul>
                                                   </div>    
                                                <label for="rejected-sched-remark-{{forloop.counter}}"><b>Reason for declining the Consultation:</b></label>
                                                <textarea  style="margin-left:1rem;margin-top:0.5rem;"cols="50" rows="3" id="rejected-sched-remark-{{forloop.counter}}" required placeholder="Possible reason for declining the Consultation Schedule"></textarea>

                                          </div>
                                          <div  class="modal-footer"  style="font-size:12px;">
                                             <div class="form-group">
                                                <button class="btn btn-primary" style="font-size: 12px;" id="reject-patient-{{forloop.counter}}" data-dismiss="modal">Yes, I'm sure.</button>
                                                <button class="btn btn-primary"  type="button" style="font-size: 12px;" data-dismiss="modal">No, I want to go back</button>
                                             </div>
                                          </div>
                                       </form>

                                          <script>
                                             $('input[type="checkbox"]').on('change', function() {
                                                $('input[name="' + this.name + '"]').not(this).prop('checked', false);
                                                document.getElementById("rejected-sched-remark-{{forloop.counter}}").value = $(this).val();
                                             });

                                             $('#reject-patient-{{forloop.counter}}').click(function(e){
                                                e.preventDefault();
                                                if ($('#rejected-sched-remark-{{forloop.counter}}').val().length < 1){
                                                   alert("Please add a possible reason for declining the Consultation Schedule.");
                                                }
                                                else{
                                                   console.log("pending schedule!");
                                                   console.log($('#reject-topic-{{forloop.counter}}').val());
                                                                                                
                                                   $.ajax({
                                                      type:"POST",
                                                      async:true,
                                                      url:'/rejectsched/',
                                                      data:{
                                                         csrfmiddlewaretoken: '{{ csrf_token }}',
                                                         r_sched_uname: $('#reject-patient-name-{{forloop.counter}}').val(),
                                                         r_sched_topic: $('#reject-topic-{{forloop.counter}}').val(),
                                                         r_sched_created_on: $('#reject-created-on-{{forloop.counter}}').val(),
                                                         r_sched_pk: $('#reject-pk-{{forloop.counter}}').val(),
                                                         r_sched_remark: $('#rejected-sched-remark-{{forloop.counter}}').val()
                                                      },
                                                      success:function(){
                                                         alert("Decline done. Please refresh to view changes.")
                                                         console.log("Done declining the schedule!!");
                                                         $('#reject-patient-{{forloop.counter}}').attr("data-dismiss","modal");
                                                      }
                                                   });
                                                }
                                             });
                                          </script>                                       
                                    </div>
                                 </div>
                              </div>
                              {% empty %}
                                 <hr>
                                 <p style="font-size: 12px;margin-left:1rem;">No pending schedules yet.</p>
                              {% endfor%}
                           </div>
                              
                           <!-- ONGOING SCHEDULES -->
                           <div class="patient-tab-content" id="ongoing-scheds">
                              {% for schedule in doctor.schedules.all %}
                              <form method="post"> 
                                 {% csrf_token %}
                                 <input hidden id="ongoing-patient-name-{{forloop.counter}}" name="ongoing-sched-patient-username" value="{{schedule.patient_username}}">
                                 <input hidden id="ongoing-topic-{{forloop.counter}}" name="ongoing-sched-topic" value="{{schedule.schedule_topic}}">
                                 <input hidden id="ongoing-created-on-{{forloop.counter}}" name="ongoing-sched-created-on" value="{{schedule.created_on}}">                                                
                                 <input hidden id="ongoing-pk-{{forloop.counter}}" name="ongoing-sched-pk" value="{{schedule.pk}}">  
                                 <input class="collapsible" style="padding:10px; border-bottom:none;" id="ongoing-patient-{{schedule.pk}}" name="ongoing-patient-name" readonly value="{{forloop.counter}}. {{schedule.patient_username}}">
                                 <div class="content"  style="font-size: 12px; border-radius:10px;" >
                                    <p  id="ongoing-patient-{{schedule.patient_hiv_status}}" name="ongoing-patient-hiv-status">
                                       <b>HIV Status: </b> {{schedule.patient_hiv_status}}
                                    </p>
                                    <p >
                                       <b>Consultation Date: </b>
                                       <a id="ongoing-patient-{{schedule.schedule_date}}" name="ongoing-patient-sched-date"> {{schedule.schedule_date}}</a>
                                    </p>
                                    <p>
                                       <b>Consultation Topic:</b>
                                       <a id="ongoing-patient-{{forloop.counter}}" name="ongoing-patient-sched-topic">{{schedule.schedule_topic}}</a>
                                    </p>
                                    <p style="margin-bottom:0rem;"><b>Patient Consultation details: </b></p>
                                    <textarea readonly style="margin-left:1rem;margin-top:0.5rem;"cols="50" rows="4" id="ongoing-patient-{{schedule.schedule_notes}}" name="ongoing-patient-sched-notes">{{schedule.schedule_notes}}</textarea>
                                    <p style= "margin-bottom:0px; font-size: 12px; color:grey;">seen by: 
                                       {% for viewer in schedule.users_viewed.all %}
                                          {{viewer.viewer_name}} |
                                       {% empty %}
                                       ...
                                       {% endfor %}
                                    </p>
                 
                                    <hr style="border-top: 2px solid rgba(0, 0, 0, 0.1); margin-top:.5rem; margin-bottom:0px;">  
                                    <p class="doc-remarks-header" ><b>Doctor(s) Remarks: </b></p>
                                    <hr style="margin:0.5rem;">
                                    <input style="margin-left:1rem;" type="button" id="add-ongoing-remark-btn-{{forloop.counter}}" name="add-ongoing-remark-btn" data-toggle="modal" data-target="#add-ongoing-remark-modal-{{forloop.counter}}" value="Add a remark" readonly>

                                    <div id="ongoing-remarks">
                                    {% for remark in schedule.doc_remark.all %}
                                       <hr style="margin:0rem 0rem;">
                                       <div  style="margin-left:1rem; margin-bottom:0rem;">
                                          {% if remark.remark_seen == True %}
                                          <i style='font-size:12px' class='fas'>&#xf06e;</i>
                                          {% else %}
                                          <i style='font-size:12px' class='fas'>&#xf070;</i>
                                          {% endif %}
                                          <b>Dr.{{remark.author}}:</b>{{remark.text}}
                                       </div>
                                    {% empty %}
                                       <hr style="margin:0rem 0rem;">
                                       <p>No remarks yet..</p>
                                    {% endfor%}
                                    </div>

                                    <hr style="margin:0rem;">
                                    <div class="submit-options" style="margin-top:0.5rem; margin-bottom:0.5rem;">
                                       <button style=" font-size:12px;" class="btn btn-primary"  id="submit-ongoing-sched-{{forloop.counter}}">mark finish</button>
                                    </div>
                                 </div>
                              </form>

                              <script>
                                 $('#submit-ongoing-sched-{{forloop.counter}}').click(function(e){
                                    e.preventDefault();
                                    console.log("ongoing schedule!");
                                                                                
                                    $.ajax({
                                       type:"POST",
                                       async:true,
                                       url:'/schedfinished/',
                                       data:{
                                          csrfmiddlewaretoken: '{{ csrf_token }}',
                                          o_sched_uname: $('#ongoing-patient-name-{{forloop.counter}}').val(),
                                          o_sched_created_on: $('#ongoing-created-on-{{forloop.counter}}').val(),
                                          o_sched_pk: $('#ongoing-pk-{{forloop.counter}}').val(),
                                          o_sched_topic: $('#ongoing-topic-{{forloop.counter}}').val()
                                       },
                                       success:function(){
                                          alert("successfully marked finish!")
                                          console.log("marked finish successful!!");
                                       }
                                    });
                                 });
                              </script>

                              <!-- modal for adding an ongoing sched remark -->
                              <div class="modal fade" id="add-ongoing-remark-modal-{{forloop.counter}}" tabindex="-1" role="dialog" aria-hidden="true">
                                 <div class="modal-dialog" role="document">
                                    <div class="modal-content" id="modal-content-{{schedule.patient_username}}">
                                       <div class="modal-header" style="background-color: #802400;">
                                          <h5 class="modal-title" id="modal-title-{{schedule.patient_username}}" style="color:#ffffff;">Add a Remark</h5>
                                          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                             <span aria-hidden="true" style="color:#ffffff;">&times;</span>
                                          </button>
                                       </div>
                                       <div class="modal-body"  style="font-size:12px;">
                                          <form  method="post">
                                             {% csrf_token %}
                                             <input hidden id="ongoing_remark_type_{{forloop.counter}}" name="remark_type" value="accepted">
                                             <input hidden id="ongoing_remark_parent_pk_{{forloop.counter}}" name="remark_parent_pk" value="{{schedule.pk}}">
                                             <input hidden id="ongoing_parent_pusername_{{forloop.counter}}" name="parent_pusername" value="{{schedule.patient_username}}">
                                             <textarea cols="50" rows="4" id="ongoing-sched-remark-{{forloop.counter}}" name="sched-remark"></textarea>
                                             
                                             <div class="form-group">
                                                <button class="btn btn-primary" type="submit" style="font-size: 12px;" id="ongoing-remark-submit-{{forloop.counter}}" data-dismiss="modal">Done</button>
                                                <button class="btn btn-primary"  type="button" style="font-size: 12px;" data-dismiss="modal">Go Back</button>
                                             </div>
                                          </form>
                                       </div>
                                    </div>
                                 </div>
                              </div>

                              <script>
                                 $('#ongoing-remark-submit-{{forloop.counter}}').click(function(e){
                                    e.preventDefault();
                                    console.log("ongoing schedule!");
                                                                                    
                                    $.ajax({
                                       type:"POST",
                                       async:true,
                                       url:'/addRemark/',
                                       data:{
                                          csrfmiddlewaretoken: '{{ csrf_token }}',
                                          p_sched_uname: $('#ongoing_parent_pusername_{{forloop.counter}}').val(),
                                          p_sched_remark: $('#ongoing-sched-remark-{{forloop.counter}}').val(),
                                          p_sched_pk: $('#ongoing_remark_parent_pk_{{forloop.counter}}').val(),
                                          remark_type: $('#ongoing_remark_type_{{forloop.counter}}').val()
                                       },
                                       success:function(){
                                          alert("successfully added a remark!")
                                          console.log("added a remark successful!!");
                                          $('#ongoing-remark-submit-{{forloop.counter}}').attr("data-dismiss","modal");
                                          remark = $('#ongoing-sched-remark-{{forloop.counter}}');
                                          $('#ongoing-remarks').append(
                                             '<hr style="margin-left:1rem; margin:0rem 0rem;">' +
                                             '<i style="margin-left:1rem;font-size:12px" class="fas">'+ '&#xf070;' + '</i>' +
                                             '<b>' + ' {{doctor.name}}' + ':' + '</b>' + remark.val() 
                                             
                                          );
                                          remark.val("");
                                          console.log("remark added to UI too.");
                                       }
                                    });
                                 });
                              </script>
                              <!-- end for adding a ongoing remark -->

                              {% empty %}
                                 <hr>
                                 <p  style="font-size: 12px;margin-left:1rem;">No ongoing consultation schedules yet.</p>
                              {% endfor%}
                           </div>
                              
  
                           <div class="patient-tab-content" id="finished-scheds">

                                 <!-- <p> FINISHED SCHEDULES</p>  -->
                                 {% for schedule in doctor.finished_scheds.all %}
                                 <form action="{% url 'schedFinished' %}" method="post"> 
                                    {% csrf_token %}
                                    <input class="collapsible" style="padding:10px; border-bottom:none;" id="finished-patient-{{schedule.pk}}" name="finished-patient-name" readonly value="{{forloop.counter}}. {{schedule.patient_username}}">
                                    <div class="content"  style="font-size: 12px; border-radius:10px;" >
                                       <p  id="finished-patient-{{schedule.patient_hiv_status}}" name="finished-patient-hiv-status">
                                          <b>HIV Status: </b> {{schedule.patient_hiv_status}}
                                       </p>
                                       <p >
                                          <b>Consultation Date: </b>
                                          <a id="finished-patient-{{schedule.schedule_date}}" name="finished-patient-sched-date"> {{schedule.schedule_date}}</a>
                                       </p>
                                       <p>
                                          <b>Consultation Topic:</b>
                                          <a id="finished-patient-{{forloop.counter}}" name="finished-patient-sched-topic">{{schedule.schedule_topic}}</a>
                                       </p>
                                       
                                       <p style="margin-bottom:0rem;"><b>Patient Consultation details: </b></p>
                                       <textarea readonly style="margin-left:1rem;margin-top:0.5rem;"cols="50" rows="4" id="finished-patient-{{schedule.schedule_notes}}" name="finished-patient-sched-notes">{{schedule.schedule_notes}}</textarea>
                                       
                                       <p style= "margin-bottom:0px; font-size: 12px; color:grey;">seen by: 
                                             {% for viewer in schedule.users_viewed.all %}
                                                {{viewer.viewer_name}} |
                                             {% empty %}
                                             ...
                                             {% endfor %}
                                          </p>
                                       <hr style="border-top: 2px solid rgba(0, 0, 0, 0.1); margin-top:.5rem; margin-bottom:0px;">  
                                       <p class="doc-remarks-header"><b>Doctor(s) Remarks: </b></p>
                                       <hr style="margin:0.5rem;">
                                       <input style="margin-left:1rem;" type="button" id="add-finished-remark-btn-{{forloop.counter}}" name="add-finished-remark-btn" data-toggle="modal" data-target="#add-finished-remark-modal-{{forloop.counter}}" value="Add a remark" readonly>
                                    
                                       <div id="finished-remarks">
                                          {% for remark in schedule.doc_remark.all %}
                                             <hr style="margin:0rem 0rem;">
                                             <div  style="margin-left:1rem; margin-bottom:0rem;">
                                                {% if remark.remark_seen == True %}
                                                <i style='font-size:12px' class='fas'>&#xf06e;</i>
                                                {% else %}
                                                <i style='font-size:12px' class='fas'>&#xf070;</i>
                                                {% endif %}
                                                <b>Dr.{{remark.author}}:</b>{{remark.text}}
                                             </div>
                   
                                          {% empty %}
                                             <hr style="margin:0rem 0rem;">
                                             <p>No remarks yet..</p>
                                          {% endfor%}
                                       </div>
                                       <hr style="margin:0rem 0rem;">
                                    </div>
                                 </form>  
                                 
                                  <!-- modal for adding a finished sched remark -->
                                 <div class="modal fade" id="add-finished-remark-modal-{{forloop.counter}}" tabindex="-1" role="dialog" aria-hidden="true">
                                    <div class="modal-dialog" role="document">
                                       <div class="modal-content" id="modal-content-{{schedule.patient_username}}">
                                          <div class="modal-header" style="background-color: #802400;">
                                             <h5 class="modal-title" id="modal-title-{{schedule.patient_username}}" style="color:#ffffff;">Add a Remark</h5>
                                             <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                <span aria-hidden="true" style="color:#ffffff;">&times;</span>
                                             </button>
                                          </div>
                                          <div class="modal-body"  style="font-size:12px;">
                                             <form method="post"> 
                                                {% csrf_token %}
                                                <input hidden id="finished_remark_type_{{forloop.counter}}" name="remark_type" value="finished">
                                                <input hidden id="finished_remark_parent_pk_{{forloop.counter}}" name="remark_parent_pk" value="{{schedule.pk}}">
                                                <input hidden id="finished_parent_pusername_{{forloop.counter}}" name="parent_pusername" value="{{schedule.patient_username}}">

                                                <textarea cols="50" rows="4" id="finished-sched-remark-{{forloop.counter}}" name="sched-remark"></textarea>
                                                
                                                <div class="form-group">
                                                   <button class="btn btn-primary"  type="submit" style="font-size: 12px;" id="finished-remark-submit-{{forloop.counter}}" data-dismiss="modal">Done</button>
                                                   <button class="btn btn-primary"  type="button" style="font-size: 12px;" data-dismiss="modal">Go Back</button>
                                                </div>
                                             </form>
                                          </div>
                                       </div>
                                    </div>
                                 </div>

                                 <script>
                                    $('#finished-remark-submit-{{forloop.counter}}').click(function(e){
                                       e.preventDefault();
                                       console.log("finished schedule!");
                                                                                       
                                       $.ajax({
                                          type:"POST",
                                          async:true,
                                          url:'/addRemark/',
                                          data:{
                                             csrfmiddlewaretoken: '{{ csrf_token }}', 
                                             p_sched_uname: $('#finished_parent_pusername_{{forloop.counter}}').val(),
                                             p_sched_remark: $('#finished-sched-remark-{{forloop.counter}}').val(),
                                             p_sched_pk: $('#finished_remark_parent_pk_{{forloop.counter}}').val(),
                                             remark_type: $('#finished_remark_type_{{forloop.counter}}').val()
                                          },
                                          success:function(){
                                             alert("successfully added a remark!")
                                             console.log("added a remark successful!!");
                                             $('#finished-remark-submit-{{forloop.counter}}').attr("data-dismiss","modal");
                                             remark = $('#finished-sched-remark-{{forloop.counter}}');
                                             $('#finished-remarks').append(
                                                '<hr style="margin-left:1rem; margin:0rem 0rem;">' +
                                                '<i style="margin-left:1rem;font-size:12px" class="fas">'+ '&#xf070;' + '</i>' +
                                                '<b>' + ' {{doctor.name}}' + ':' + '</b>' + remark.val() 
                                                
                                             );
                                             remark.val("");
                                             console.log("remark added to UI too.");
                                          }
                                       });
                                    });
         
                                 </script>
                                 <!-- end for adding a finished remark -->

                              {% empty %}
                                 <hr>
                                 <p  style="font-size: 12px;margin-left:1rem;">No finished consultation schedules yet.</p>
                              {% endfor%}
                           </div>

                           <!-- <p>REJECTED SCHEDULES</p>  -->
                           <div class="patient-tab-content" id="rejected-scheds">
                              {% for schedule in doctor.rejected_scheds.all %}
                              <form action="{% url 'rejectSched' %}" method="post"> 
                                 {% csrf_token %}
                                 <input class="collapsible" style="padding:10px; border-bottom:none;" id="rejected-patient-{{forloop.counter}}" name="rejected-patient-name" readonly value="{{forloop.counter}}. {{schedule.patient_username}}">
                                 <div class="content"  style="font-size: 12px; border-radius:10px;" >
                                    <p id="rejected-patient-{{schedule.patient_hiv_status}}" name="rejected-patient-hiv-status">
                                       <b>HIV Status: </b> {{schedule.patient_hiv_status}}
                                    </p>
                                    <p>
                                       <b>Consultation Date: </b>
                                       <a id="rejected-patient-{{schedule.schedule_date}}" name="rejected-patient-sched-date"> {{schedule.schedule_date}}</a>
                                    </p>
                                    <p>
                                       <b>Consultation Topic:</b>
                                       <a id="rejected-patient-{{forloop.counter}}" name="rejected-patient-sched-topic">{{schedule.schedule_topic}}</a>
                                    </p>
                                    <p style="margin-bottom:0rem;"><b>Patient Consultation details: </b></p>
                                    <textarea style="margin-left:1rem;margin-top:0.5rem;"cols="50" rows="4" id="rejected-patient-{{schedule.pk}}" name="rejected-patient-sched-notes">{{schedule.schedule_notes}}</textarea>
                                    <p style= "margin-bottom:0px; font-size: 12px; color:grey;">seen by: 
                                       {% for viewer in schedule.users_viewed.all %}
                                          {{viewer.viewer_name}} |
                                       {% empty %}
                                       ...
                                       {% endfor %}
                                    </p>
                                    <hr style="border-top: 2px solid rgba(0, 0, 0, 0.1); margin-bottom:0px;">  
                                    <p class="doc-remarks-header"><b>Doctor(s) Remarks: </b></p>
                                    <hr style="margin:0rem;">
                             
                                    {% for remark in schedule.doc_remark.all %}
                                       <hr style="margin:0rem 0rem;">
                                       <div style="margin-left:1rem; margin-bottom:0rem;">
                                          {% if remark.remark_seen == True %}
                                          <i style='font-size:12px' class='fas'>&#xf06e;</i>
                                          {% else %}
                                          <i style='font-size:12px' class='fas'>&#xf070;</i>
                                          {% endif %}
                                          <b>Dr.{{remark.author}}:</b>{{remark.text}}
                                       </div>
                                    {% empty %}
                                       <hr style="margin:0rem 0rem;">
                                       <p>No remarks yet..</p>
                                    {% endfor%}
                                    <hr style="margin:0rem 0rem;">
                                 </div>
                              </form>
                              {% empty %}
                                 <hr style="margin:0rem 0rem;">
                                 <p  style="font-size: 12px;margin-left:1rem;">No declined consultation schedules yet.</p>
                              {% endfor%}
                           </div>
                        </div>
                     </div>   
                  </div>
               </div>
               <!-- END OF SCHEDULES TAB -->

               <!-- NOTIFICATIONS TAB -->
               <div class="tab-pane fade show active py-5" id="notifs" role="tabpanel" aria-labelledby="v-pills-fitness-tab">
                  <div class="col-md-12" style="border-style: ridge;"> 
                     <div class="card card-plain"  style="padding-top: 1.5rem;">
                        <div class="card-header" style="border:1px solid rgba(0, 0, 0, 0.125);">
                           <h4 class="card-title">Notifications</h4>
                        </div>
                        <div class="card-body" style="margin-bottom: 1rem;">
                          
                           <div class="table-responsive">
                              <table class="table table-hover" style="font-family:Roboto, Arial, sans-serif;">
                                <thead class=" text-primary">
                                  <th>
                                    Action
                                  </th>
                                  <th>
                                    Notification
                                  </th>
                                  <th class="text-right">
                                    Date
                                  </th>
                                </thead>
                                <tbody>
                                    {% for docNotif in doctor.doctorNotifs.all %}
                                       <!-- new notifs, change to color green -->
                                       {% if docNotif.created_on > doctor.last_log_out %}
                                          <tr class="notif-bar" id="notif-row-{{forloop.counter}}" style="transform: rotate(0);background-color:#d6f5d6;" data-toggle="modal" data-target="#notif-content-{{forloop.counter}}" data-id="notif-{{forloop.counter}}">
                                       {% endif %}
                                       <!-- old notifs, change color to lightgray-white -->
                                       {% if docNotif.created_on < doctor.last_log_out %}
                                          <tr class="notif-bar" id="notif-row-{{forloop.counter}}" style="transform: rotate(0);" data-toggle="modal" data-target="#notif-content-{{forloop.counter}}" data-id="notif-{{forloop.counter}}">
                                       {% endif %}

                                       {% if docNotif.notif_status %}
                                          <td> <a data-toggle="modal" data-target="#notif-content" class="stretched-link"></a>
                                             <div class="custom-control custom-checkbox">
                                                <a data-toggle="modal" data-target="#notif-content" class="stretched-link"></a>
                                                <input type="checkbox" class="custom-control-input" id="notif-checkbox-{{forloop.counter}}" checked>
                                                <label class="custom-control-label" for="checkbox-{{forloop.counter}}"> {{docNotif.action_type}}</label>
                                            </div>  
                                            
                                          </td>
                                       {% endif %}
                                       {% if not docNotif.notif_status %}
                                          <td> <a data-toggle="modal" data-target="#notif-content" class="stretched-link"></a>
                                             <div class="custom-control custom-checkbox">
                                                <a data-toggle="modal" data-target="#notif-content" class="stretched-link"></a>
                                                <input type="checkbox" class="custom-control-input" id="notif-checkbox-{{forloop.counter}}">
                                                <label class="custom-control-label" for="checkbox-{{forloop.counter}}"> {{docNotif.action_type}}</label>
                                            </div>  
                                          </td>
                                       {% endif %}
                                          <td>
                                          {{docNotif.notif}}
                                          </td>
                                          <td class="text-right" style="font-family:Roboto, Arial, sans-serif; font-size:12px;">
                                          {{docNotif.created_on}}
                                          </td>
                                       </tr>

                                       <!-- MODAL for accept sched notif-->
                                       <div class="modal fade" id="notif-content-{{forloop.counter}}" tabindex="-1" role="dialog" aria-hidden="true" >
                                          <div class="modal-dialog" role="document">
                                             <div class="modal-content">
                                                <div class="modal-header" style="background-color: #800000;">
                                                   <h5 class="modal-title" style="color:#ffffff;">{{docNotif.subject}} </h5>
                                                   <button type="button" data-dismiss="modal" style="background-color: transparent; border:none;" aria-label="Close">
                                                   <span aria-hidden="true"  style="color:#ffffff;">&times;</span>
                                                   </button>
                                                </div>
                                                {% if docNotif.subject == "Patient" %}
                                                   {% for patient in all_patients%}
                                                      {% if patient.pk == docNotif.action_pk %}
                                                         <div class="modal-body" style="padding:1rem; font-size: small; max-height: calc(100vh - 210px);overflow-y: auto;">
                                                            <div id="notif-new-patient-content" style="border:1px solid lightgray; background: #880000;">
                                                               {% if patient.patient_image %}
                                                                  <img class="center" src="{{patient.patient_image.url}}" id="notif-new-patient-pic" alt="user profile picture">
                                                               {% endif %}
                                                               {% if not patient.patient_image %}
                                                                  <img class="center" src="{% static 'portal/images/user.png' %}"  id="notif-new-patient-pic" alt="user profile picture">
                                                               {% endif %}
                                                               <p class="white center bold" style="margin-bottom:1rem;">{{patient.username}}</p>
                                                               <p class="white center" >Age: {{patient.age}}</p>
                                                               <p class="white center">HIV Level: {{patient.HIV_status}}</p>
                                                               <p class="white center">Work: {{patient.work}}</p>  
                                                               <p class="white center" style="margin-bottom:1rem;">Email: {{patient.email}}</p>   
                                                               <p class="white center">Contact Number: {{patient.call_number}}</p>
                                                                                                                               
                                                            </div>
                                                         </div>
                                                         <div class="modal-footer">
                                                            <button class="btn btn-primary" data-dismiss="modal">Back</button>
                                                         </div>
                                                      {% endif %}
                                                   {% endfor%}
                                                {% endif %}
                                                {% if docNotif.subject == "ICR Form"%}
                                                   {% for patient in patients%}
                                                      {% if patient.icr.pk == docNotif.action_pk %}
                                                         <div class="modal-body" style="padding:1rem; font-size: small; max-height: calc(100vh - 210px);overflow-y: auto;">                                                               
                                                            <div id="notif-profile-content" style="border:1px solid lightgray;">
                                                               <p style="margin-bottom:1rem; margin-top:1rem;">Last name: 
                                                                  <input value="{{patient.icr.last_name}}"></p>
                                                               <p style="margin-bottom:1rem;">First Name: 
                                                                  <input value="{{patient.icr.first_name}}"></p>
                                                               <p style="margin-bottom:1rem;">Middle Initial: 
                                                                  <input value="{{patient.icr.middle_name}}"></p>
                                                               <p style="margin-bottom:1rem;">Date of Visit: 
                                                                  <input value="{{patient.icr.date_of_visit}}"></p>
                                                               <p style="margin-bottom:1rem;">Age: 
                                                                  <input value="{{patient.icr.age}}"></p>
                                                               <p style="margin-bottom:1rem;">Birth Date: 
                                                                  <input value="{{patient.icr.birthdate}}"></p>
                                                               <p style="margin-bottom:1rem;">Sex: 
                                                                  <input value="{{patient.icr.sex}}"></p>
                                                               <p style="margin-bottom:1rem;">Civil Status: 
                                                                  <input value="{{patient.icr.civil_status}}"></p>
                                                               <p style="margin-bottom:1rem;">Phone Number: 
                                                                  <input value="{{patient.icr.phone_number}}"></p>
                                                               <p style="margin-bottom:1rem;">Home Address: 
                                                                  <input value="{{patient.icr.home_address}}"></p>
                                                               <p style="margin-bottom:1rem;">Occupation: 
                                                                  <input value="{{patient.icr.occupation}}"></p>
                                                               <p style="margin-bottom:1rem;">Work Address: 
                                                                  <input value="{{patient.icr.work_address}}"></p>
                                                               <p style="margin-bottom:1rem;">Work Telephone or Cellphone Number: 
                                                                  <input value="{{patient.icr.work_number}}"></p>
                                                               <p style="margin-bottom:1rem;">Purpose of Visit: 
                                                                  <input value="{{patient.icr.purpose_of_visit}}"></p>
                                                               <p style="margin-bottom:1rem;">Symptoms: 
                                                                  <input value="{{patient.icr.symptoms}}"></p>
                                                               <p style="margin-bottom:1rem;">Specifications:  
                                                                  <input value="{{patient.icr.specification}}"></p>
                                                            </div>
                                                            
                                                            <p style= "margin-bottom:0px; margin-left:0rem; font-size: 12px; color:grey;">seen by: 
                                                               {% for viewer in patient.icr.docs_viewed.all %}
                                                                  {{viewer.viewer_name}} |
                                                               {% empty %}
                                                               ...
                                                               {% endfor %}
                                                            </p>
               
                                                            <hr style="border-top: 2px solid rgba(0, 0, 0, 0.1); margin-top:0rem; margin-bottom:0px;">                                                  
                                                            <p class="doc-remarks-header"><b>Doctor(s) Remarks: </b></p>
                                                            <hr style="margin:0rem;">
                                                            
                                                            {% for remark in patient.icr.doctor_remarks.all %}
                                                               <hr style="margin:0rem 0rem;">
                                                               <div  id="notif-profile-remarks" style="margin-left:1rem; margin-bottom:0rem;">
                                                                  {% if remark.remark_seen == True %}
                                                                  <i style='font-size:12px' class='fas'>&#xf06e;</i>
                                                                  {% else %}
                                                                  <i style='font-size:12px' class='fas'>&#xf070;</i>
                                                                  {% endif %}
                                                                  <b>Dr.{{remark.author}}:</b>{{remark.text}}
                                                               </div>
                                                            {% empty %}
                                                            <hr style="margin:0rem;">
                                                            <p>No remarks yet..</p>
                                                                                                                           
                                                            {% endfor%}
                                                            <hr style="margin:0rem;">
                                                         </div>
                                                         <div class="modal-footer">
                                                            <button class="btn btn-primary" data-dismiss="modal">Back</button>
                                                         </div>
                                                      {% endif %}
                                                   {% endfor %}
                                                {% endif %}
                                                
                                                {% if docNotif.subject == "Appointment" %}
                                                   {% if docNotif.action_taken == 0 %}   <!-- 0 MEANS NO DOCTOR ACTION HAS BEEN TAKEN, SCHEDULE IS STILL PENDING-->
                                                      {% for schedule in doctor.pending_scheds.all %}
                                                         {% if schedule.pk == docNotif.action_pk %}
                                                            <div class="modal-body" style="padding:1rem; font-size: small; max-height: calc(100vh - 210px);overflow-y: auto;">
                                                               <div id="sched-notif-accepted">
                                                                  <form id="pending-notif-form-{{forloop.counter}}" method="post"> 
                                                                     {% csrf_token %}
                                                                     <input hidden id="notif-pending-sched-patient-username-{{forloop.counter}}" name="pending-sched-patient-username" value="{{schedule.patient_username}}">
                                                                     <input hidden id="notif-pending-sched-topic-{{forloop.counter}}" name="pending-sched-topic" value="{{schedule.schedule_topic}}">
                                                                     <input hidden id="notif-pending-sched-pk-{{forloop.counter}}" name="pending-sched-pk" value="{{schedule.pk}}">
                                                                     
                                                                     <div class="form-group">
                                                                        <p style="margin-left: 0rem;color: lightcoral;"><b>Schedule Status: </b>Pending</p>
                                                                     </div>

                                                                     <div class="form-group">
                                                                        <label><b>Patient Username: </b></label>
                                                                        <a id="request-patient-username-{{forloop.counter}}" name="ongoing-patient-hiv-status" >{{schedule.patient_username}}</a>
                                                                     </div>
                                                                     <div class="form-group">
                                                                        <label><b>HIV Status: </b></label>
                                                                        <a id="request-patient-hiv-stat-{{schedule.patient_hiv_status}}" name="pending-patient-hiv-status" >{{schedule.patient_hiv_status}}</a>
                                                                     </div>

                                                                     <div class="form-group">
                                                                        <label><b>Consultation Date: </b></label>
                                                                        <a id="request-patient-{{schedule.schedule_date}}" name="pending-patient-sched-date" >{{schedule.schedule_date}}</a>
                                                                     </div>

                                                                     <div class="form-group">
                                                                        <label><b>Consultation Topic:</b></label>
                                                                        <a id="request-patient-{{forloop.counter}}" name="pending-patient-sched-topic" >{{schedule.schedule_topic}}</a>
                                                                     </div>

                                                                     <div class="form-group" style="margin-bottom: 0rem;">
                                                                        <label style="margin-bottom: 0rem;"><b>Patient Consultation details: </b></label>
                                                                        <a  id="pending-patient-{{schedule.schedule_notes}}" name="pending-patient-sched-notes">{{schedule.schedule_notes}}</a>
                                                                     </div>
                                                                     <p style= "margin-left:0rem; padding-bottom:0rem; margin-bottom:0px; font-size: 12px; color:grey;">seen by: 
                                                                        {% for viewer in schedule.users_viewed.all %}
                                                                           {{viewer.viewer_name}} |
                                                                        {% empty %}
                                                                        ...
                                                                        {% endfor %}
                                                                     </p>
                                                                     
                                                                     <hr style="border-top: 2px solid rgba(0, 0, 0, 0.1); margin-top:.5rem; margin-bottom:0px;"> 
                                                                     <div class="form-group">

                                                                           <div style="display: none; border:1px solid lightgray; padding:0.5rem; padding-top:0rem;" id="decline-details-{{forloop.counter}}" >
                                                                              <input hidden id="notif-reject-patient-name-{{forloop.counter}}" name="reject-sched-patient-username" value="{{schedule.patient_username}}">
                                                                              <input hidden id="notif-reject-topic-{{forloop.counter}}" name="reject-sched-topic" value="{{schedule.schedule_topic}}">
                                                                              <input hidden id="notif-reject-created-on-{{forloop.counter}}" name="reject-sched-created-on" value="{{schedule.created_on}}">                                                
                                                                              <input hidden id="notif-reject-pk-{{forloop.counter}}" name="reject-sched-pk" value="{{schedule.pk}}">                                                                                               
                                                                              <div style="background-color:lightgray; margin-top:0.5rem;">
                                                                                 <p style="font-size: 15px; color: #802400; margin-bottom: 0.5rem;">Are you sure to reject the requested consultation?  It will be added to declined consultation list. </p>
                                                                              </div>
                                                                              <hr style="margin-top: 0rem;">
                                                                              <label><b>Possible Remarks:</b></label>
                                                                                 <div id="doc-remarks">
                                                                                    <ul style="list-style-type: none;">
                                                                                       <li><input type="checkbox" name="pos-remark" value="out of time"/>out of time</li>
                                                                                       <li><input type="checkbox" name="pos-remark" value="in a meeting"/>in a meeting</li>
                                                                                       <li><input type="checkbox" name="pos-remark" value="prior appointment"/>prior appointment</li>
                                                                                       <li><input type="checkbox" name="pos-remark" value="not feeling well"/>not feeling well</li>
                                                                                    </ul>
                                                                                 </div>    
                                                                              <label for="notif-rejected-sched-remark-{{forloop.counter}}"><b>Reason for declining the Consultation:</b></label>
                                                                              <textarea  style="margin-left:1rem;margin-top:0.5rem;"cols="50" rows="3" id="notif-rejected-sched-remark-{{forloop.counter}}" required placeholder="Possible reason for declining the Consultation Schedule.."></textarea>
                                                                           </div>

                                                                           <p class="doc-remarks-header" ><b>Doctor(s) Remarks: </b></p>
                                                                           <hr style="margin:0rem 0rem;">
                                                                           {% for remark in schedule.doc_remark.all %}
                                                                              <hr style="margin:0rem 0rem;">
                                                                              <div style="margin-left:1rem; margin-bottom:0rem;">
                                                                                 {% if remark.remark_seen == True %}
                                                                                 <i style='font-size:12px' class='fas'>&#xf06e;</i>
                                                                                 {% else %}
                                                                                 <i style='font-size:12px' class='fas'>&#xf070;</i>
                                                                                 {% endif %}
                                                                                 <b>Dr.{{remark.author}}:</b>{{remark.text}}
                                                                              </div>
                                                                           {% empty %}
                                                                              <hr style="margin:0rem 0rem;">
                                                                              <p>No remarks yet..</p>
                                                                           {% endfor%}
                                                                              
                                                                           <hr style="margin:0rem 0rem;">
                                                                           <div id="normal-remark">
                                                                              <label style="margin-bottom: 0rem; padding-left: 1rem;">Add a remark:</label>
                                                                              <textarea style="margin-left:1rem;margin-top:0.5rem;"cols="50" rows="2" id="pending-patient-remark-{{schedule.pk}}" name="doc-notif-remark"></textarea>
                                                                              <hr style="margin:0rem 0rem;">
                                                                           </div>                                                                           
                                                                     </div>
                                                                  </form>
                                                               </div>
                                                            </div>
                                                            <div class="modal-footer" style="padding-top: 0.5rem; padding-bottom: 0rem;">
                                                               <div class="form-group" style="margin-bottom: 0.5rem;">
                                                                  <button class="btn btn-primary" id="notif-accept-btn-{{forloop.counter}}" data-dismiss="modal">Accept</button>
                                                                  <button class="btn btn-primary" id="notif-attempt-reject-btn-{{forloop.counter}}" >Decline</button>
                                                                  <button style="display:none;" class="btn btn-primary" id="notif-back-btn-{{forloop.counter}}">Back</button>
								  <button id="appointment-sched-back" class="btn btn-primary" type="button" data-dismiss="modal">Back</button>                           

                                                                  <button style="display:none;" class="btn btn-primary" id="notif-reject-btn-{{forloop.counter}}" data-dismiss="modal">Continue to Decline</button>
                                                               </div>
                                                            </div>

                                                            <script>
                                                               // accept a appointment sched from notif
                                                               $('#notif-accept-btn-{{forloop.counter}}').click(function(e){
                                                                  e.preventDefault();
                                                                  console.log("pending schedule!");
                                                                                                                  
                                                                  $.ajax({
                                                                     type:"POST",
                                                                     async:true,
                                                                     url:'/acceptsched/',
                                                                     data:{
                                                                        csrfmiddlewaretoken: '{{ csrf_token }}', 
                                                                        p_sched_uname: $('#notif-pending-sched-patient-username-{{forloop.counter}}').val(),
                                                                        p_sched_topic: $('#notif-pending-sched-topic-{{forloop.counter}}').val(),
                                                                        p_sched_remark: $('#pending-patient-remark-{{schedule.pk}}').val(),
                                                                        p_sched_pk: $('#notif-pending-sched-pk-{{forloop.counter}}').val()
                                                                     },
                                                                     success:function(){
                                                                        alert("Notification Consultation Schedule marked accepted. Refresh to view the changes.")
                                                                        console.log("pending accepted!!");
                                                                     }
                                                                  });
                                                               });

                                                               $('input[type="checkbox"]').on('change', function() {
                                                                  $('input[name="' + this.name + '"]').not(this).prop('checked', false);
                                                                  document.getElementById("notif-rejected-sched-remark-{{forloop.counter}}").value = $(this).val();
                                                               });
                                                               
                                                               $('#notif-attempt-reject-btn-{{forloop.counter}}').click(function(){
                                                                  $('#normal-remark').hide();
                                                                  $('#notif-attempt-reject-btn-{{forloop.counter}}').hide();
                                                                  $('#notif-accept-btn-{{forloop.counter}}').hide();
                                                                  $('#decline-details-{{forloop.counter}}').show();
                                                                  $('#notif-reject-btn-{{forloop.counter}}').show();
                                                                  $('#notif-back-btn-{{forloop.counter}}').show();

                                                               })
                                                               $('#notif-back-btn-{{forloop.counter}}').click(function(){
                                                                  $('#normal-remark').show();
                                                                  $('#notif-attempt-reject-btn-{{forloop.counter}}').show();
                                                                  $('#notif-accept-btn-{{forloop.counter}}').show();
                                                                  $('#decline-details-{{forloop.counter}}').hide();
                                                                  $('#notif-reject-btn-{{forloop.counter}}').hide();
                                                                  $('#notif-back-btn-{{forloop.counter}}').hide();

                                                               });

                                                               $('#notif-reject-btn-{{forloop.counter}}').click(function(e){
                                                                  e.preventDefault();
                                                                  console.log("Decline Clicked!!");

                                                                  if ($('#notif-rejected-sched-remark-{{forloop.counter}}').val().length < 1){
                                                                     alert("Please add a possible reason for declining the Consultation Schedule.");
                                                                  }
                                                                  else{
                                                                     console.log("pending schedule!");
                                                                                                                  
                                                                     $.ajax({
                                                                        type:"POST",
                                                                        async:true,
                                                                        url:'/rejectsched/',
                                                                        data:{
                                                                           csrfmiddlewaretoken: '{{ csrf_token }}', //$('input[name=csrfmiddlewaretoken').val()
                                                                           r_sched_uname: $('#notif-reject-patient-name-{{forloop.counter}}').val(),
                                                                           r_sched_topic: $('#notif-reject-topic-{{forloop.counter}}').val(),
                                                                           r_sched_created_on: $('#notif-reject-created-on-{{forloop.counter}}').val(),
                                                                           r_sched_pk: $('#notif-reject-pk-{{forloop.counter}}').val(),
                                                                           r_sched_remark: $('#notif-rejected-sched-remark-{{forloop.counter}}').val()
                                                                        },
                                                                        success:function(){
                                                                           alert("Declined done. Please refresh to view changes.")
                                                                           console.log("Done declining the schedule!!");
                                                                           $('#notif-reject-patient-{{forloop.counter}}').attr("data-dismiss","modal");
                                                                        }
                                                                     });
                                                                  }
                                                               });
                                                            </script>
                                                         {% endif %}
                                                      {% endfor %}
                                                   {% endif %}


                                                   <!--  IF ACTION TAKEN IS 1 MEANING SCHEDULE HAS ALREADY BEEN ACCEPTED -->
                                                   {% if docNotif.action_taken == 1 %}
                                                      {% for schedule in doctor.schedules.all %}
                                                         {% if schedule.pk == docNotif.action_pk %}
                                                            <div class="modal-body" style="padding:1rem; font-size: small; max-height: calc(100vh - 210px);overflow-y: auto;">
                                                               <div id="sched-notif-accepted">
                                                                  <form id="accepted-notif-form-{{forloop.counter}}" method="post"> 
                                                                     {% csrf_token %}
                                                                     <input hidden id="notif-pending-sched-patient-username-{{forloop.counter}}" name="pending-sched-patient-username" value="{{schedule.patient_username}}">
                                                                     <input hidden id="notif-pending-sched-topic-{{forloop.counter}}" name="pending-sched-topic" value="{{schedule.schedule_topic}}">
                                                                     <input hidden id="notif-pending-sched-pk-{{forloop.counter}}" name="pending-sched-pk" value="{{schedule.pk}}">
                                                                     
                                                                     <div class="form-group" style="padding:0rem;">
                                                                        <p  style="margin-left: 0rem;color: green;"><b>Schedule Status: </b>Accepted</p>
                                                                     </div>

                                                                     <div class="form-group">
                                                                        <label><b>Patient Username: </b></label>
                                                                        <a id="request-patient-username-{{forloop.counter}}" name="ongoing-patient-hiv-status" >{{schedule.patient_username}}</a>
                                                                     </div>
                                                                     <div class="form-group">
                                                                        <label><b>HIV Status: </b></label>
                                                                        <a id="request-patient-hiv-stat-{{schedule.patient_hiv_status}}" name="pending-patient-hiv-status" >{{schedule.patient_hiv_status}}</a>
                                                                     </div>

                                                                     <div class="form-group">
                                                                        <label><b>Consultation Date: </b></label>
                                                                        <a id="request-patient-{{schedule.schedule_date}}" name="pending-patient-sched-date" >{{schedule.schedule_date}}</a>
                                                                     </div>

                                                                     <div class="form-group">
                                                                        <label><b>Consultation Topic:</b></label>
                                                                        <a id="request-patient-{{forloop.counter}}" name="pending-patient-sched-topic" >{{schedule.schedule_topic}}</a>
                                                                     </div>

                                                                     <div class="form-group" style="margin-bottom: 0rem;">
                                                                        <label style="margin-bottom: 0rem;"><b>Patient Consultation details: </b></label>
                                                                        <a  id="pending-patient-{{schedule.schedule_notes}}" name="pending-patient-sched-notes">{{schedule.schedule_notes}}</a>
                                                                     </div>
                                                                     <p style= "margin-left:0rem; padding-bottom:0rem; margin-bottom:0px; font-size: 12px; color:grey;">seen by: 
                                                                        {% for viewer in schedule.users_viewed.all %}
                                                                           {{viewer.viewer_name}} |
                                                                        {% empty %}
                                                                        ...
                                                                        {% endfor %}
                                                                     </p>
                                                                     
                                                                     <hr style="border-top: 2px solid rgba(0, 0, 0, 0.1); margin-top:.5rem; margin-bottom:0px;"> 
                                                                     <div class="form-group">
                                                                        <p class="doc-remarks-header" ><b>Doctor(s) Remarks: </b></p>
                                                                        <hr style="margin:0rem 0rem;">
                                                                        {% for remark in schedule.doc_remark.all %}
                                                                           <hr style="margin:0rem 0rem;">
                                                                           <div style="margin-left:1rem; margin-bottom:0rem;">
                                                                              {% if remark.remark_seen == True %}
                                                                              <i style='font-size:12px' class='fas'>&#xf06e;</i>
                                                                              {% else %}
                                                                              <i style='font-size:12px' class='fas'>&#xf070;</i>
                                                                              {% endif %}
                                                                              <b>Dr.{{remark.author}}:</b>{{remark.text}}
                                                                           </div>
                                                                        {% empty %}
                                                                           <hr style="margin:0rem 0rem;">
                                                                           <p>No remarks yet..</p>
                                                                        {% endfor%}
                                                                        
                                                                        <hr style="margin:0rem 0rem;">                                                                           
                                                                     </div>
                                                                  </form>
                                                               </div>
                                                            </div>
                                                            <div class="modal-footer" style="padding-top: 0.5rem; padding-bottom: 0rem;">
                                                               <div class="form-group" style="margin-bottom: 0.5rem;">
                                                                  <button  class="btn btn-primary" id="notif-back-btn-{{forloop.counter}}" data-dismiss="modal" >Back</button>
                                                               </div>
                                                            </div>                                                  
                                                         {% endif %}
                                                      {% endfor %}
                                                   {% endif %}


                                                    <!--  IF ACTION TAKEN IS 2 MEANING SCHEDULE HAS ALREADY BEEN REJECTED -->
                                                    {% if docNotif.action_taken == 2 %}
                                                      {% for schedule in doctor.rejected_scheds.all %}
                                                       {% if schedule.pk == docNotif.action_pk %}
                                                            <div class="modal-body" style="padding:1rem; font-size: small; max-height: calc(100vh - 210px);overflow-y: auto;">
                                                               <div id="sched-notif-accepted">
                                                                  <form id="rejected-form-{{forloop.counter}}" method="post"> 
                                                                     {% csrf_token %}
                                                                     <input hidden id="notif-pending-sched-patient-username-{{forloop.counter}}" name="pending-sched-patient-username" value="{{schedule.patient_username}}">
                                                                     <input hidden id="notif-pending-sched-topic-{{forloop.counter}}" name="pending-sched-topic" value="{{schedule.schedule_topic}}">
                                                                     <input hidden id="notif-pending-sched-pk-{{forloop.counter}}" name="pending-sched-pk" value="{{schedule.pk}}">
                                                                     
                                                                     <div class="form-group">
                                                                        <p  style="margin-left: 0rem;color: #b35900;;"><b>Schedule Status: </b>Declined</p>
                                                                     </div>

                                                                     <div class="form-group">
                                                                        <label><b>Patient Username: </b></label>
                                                                        <a id="request-patient-username-{{forloop.counter}}" name="ongoing-patient-hiv-status" >{{schedule.patient_username}}</a>
                                                                     </div>
                                                                     <div class="form-group">
                                                                        <label><b>HIV Status: </b></label>
                                                                        <a id="request-patient-hiv-stat-{{schedule.patient_hiv_status}}" name="pending-patient-hiv-status" >{{schedule.patient_hiv_status}}</a>
                                                                     </div>

                                                                     <div class="form-group">
                                                                        <label><b>Consultation Date: </b></label>
                                                                        <a id="request-patient-{{schedule.schedule_date}}" name="pending-patient-sched-date" >{{schedule.schedule_date}}</a>
                                                                     </div>

                                                                     <div class="form-group">
                                                                        <label><b>Consultation Topic:</b></label>
                                                                        <a id="request-patient-{{forloop.counter}}" name="pending-patient-sched-topic" >{{schedule.schedule_topic}}</a>
                                                                     </div>

                                                                     <div class="form-group" style="margin-bottom: 0rem;">
                                                                        <label style="margin-bottom: 0rem;"><b>Patient Consultation details: </b></label>
                                                                        <a  id="pending-patient-{{schedule.schedule_notes}}" name="pending-patient-sched-notes">{{schedule.schedule_notes}}</a>
                                                                     </div>
                                                                     <p style= "margin-left:0rem; padding-bottom:0rem; margin-bottom:0px; font-size: 12px; color:grey;">seen by: 
                                                                        {% for viewer in schedule.users_viewed.all %}
                                                                           {{viewer.viewer_name}} |
                                                                        {% empty %}
                                                                        ...
                                                                        {% endfor %}
                                                                     </p>
                                                                     
                                                                     <hr style="border-top: 2px solid rgba(0, 0, 0, 0.1); margin-top:.5rem; margin-bottom:0px;"> 
                                                                     <div class="form-group">
                                                                        <p class="doc-remarks-header" ><b>Doctor(s) Remarks: </b></p>
                                                                        <hr style="margin:0rem 0rem;">
                                                                        {% for remark in schedule.doc_remark.all %}
                                                                           <hr style="margin:0rem 0rem;">
                                                                           <div style="margin-left:1rem; margin-bottom:0rem;">
                                                                              {% if remark.remark_seen == True %}
                                                                              <i style='font-size:12px' class='fas'>&#xf06e;</i>
                                                                              {% else %}
                                                                              <i style='font-size:12px' class='fas'>&#xf070;</i>
                                                                              {% endif %}
                                                                              <b>Dr.{{remark.author}}:</b>{{remark.text}}
                                                                           </div>
                                                                        {% empty %}
                                                                           <hr style="margin:0rem 0rem;">
                                                                           <p>No remarks yet..</p>
                                                                        {% endfor%}
                                                                        <hr style="margin:0rem 0rem;">                                                                           
                                                                     </div>
                                                                  </form>
                                                               </div>
                                                            </div>
                                                            <div class="modal-footer" style="padding-top: 0.5rem; padding-bottom: 0rem;">
                                                               <div class="form-group" style="margin-bottom: 0.5rem;">
                                                                  <button  class="btn btn-primary" id="notif-back-btn-{{forloop.counter}}" data-dismiss="modal" >Back</button>
                                                               </div>
                                                            </div>                                                  
                                                         {% endif %}
                                                      {% endfor %}
                                                   {% endif %}


                                                    <!--  IF ACTION TAKEN IS 2 MEANING SCHEDULE HAS ALREADY BEEN DONE -->
                                                    {% if docNotif.action_taken == 3 %}
                                                      {% for schedule in doctor.finished_scheds.all %}
                                                       {% if schedule.pk == docNotif.action_pk %}
                                                            <div class="modal-body" style="padding:1rem; font-size: small; max-height: calc(100vh - 210px);overflow-y: auto;">
                                                               <div id="sched-notif-accepted">
                                                                  <form id="done-form-{{forloop.counter}}" method="post"> 
                                                                     {% csrf_token %}
                                                                     <input hidden id="notif-pending-sched-patient-username-{{forloop.counter}}" name="pending-sched-patient-username" value="{{schedule.patient_username}}">
                                                                     <input hidden id="notif-pending-sched-topic-{{forloop.counter}}" name="pending-sched-topic" value="{{schedule.schedule_topic}}">
                                                                     <input hidden id="notif-pending-sched-pk-{{forloop.counter}}" name="pending-sched-pk" value="{{schedule.pk}}">
                                                                     
                                                                     <div class="form-group">
                                                                        <p style="margin-left: 0rem; color: #1a8cff;;"><b>Schedule Status: </b>Finished</p>
                                                                     </div>

                                                                     <div class="form-group">
                                                                        <label><b>Patient Username: </b></label>
                                                                        <a id="request-patient-username-{{forloop.counter}}" name="ongoing-patient-hiv-status" >{{schedule.patient_username}}</a>
                                                                     </div>
                                                                     <div class="form-group">
                                                                        <label><b>HIV Status: </b></label>
                                                                        <a id="request-patient-hiv-stat-{{schedule.patient_hiv_status}}" name="pending-patient-hiv-status" >{{schedule.patient_hiv_status}}</a>
                                                                     </div>

                                                                     <div class="form-group">
                                                                        <label><b>Consultation Date: </b></label>
                                                                        <a id="request-patient-{{schedule.schedule_date}}" name="pending-patient-sched-date" >{{schedule.schedule_date}}</a>
                                                                     </div>

                                                                     <div class="form-group">
                                                                        <label><b>Consultation Topic:</b></label>
                                                                        <a id="request-patient-{{forloop.counter}}" name="pending-patient-sched-topic" >{{schedule.schedule_topic}}</a>
                                                                     </div>

                                                                     <div class="form-group" style="margin-bottom: 0rem;">
                                                                        <label style="margin-bottom: 0rem;"><b>Patient Consultation details: </b></label>
                                                                        <a  id="pending-patient-{{schedule.schedule_notes}}" name="pending-patient-sched-notes">{{schedule.schedule_notes}}</a>
                                                                     </div>
                                                                     <p style= "margin-left:0rem; padding-bottom:0rem; margin-bottom:0px; font-size: 12px; color:grey;">seen by: 
                                                                        {% for viewer in schedule.users_viewed.all %}
                                                                           {{viewer.viewer_name}} |
                                                                        {% empty %}
                                                                        ...
                                                                        {% endfor %}
                                                                     </p>
                                                               
                                                                     <hr style="border-top: 2px solid rgba(0, 0, 0, 0.1); margin-top:.5rem; margin-bottom:0px;"> 
                                                                     <div class="form-group">
                                                                        <p class="doc-remarks-header" ><b>Doctor(s) Remarks: </b></p>
                                                                        <hr style="margin:0rem 0rem;">
                                                                        {% for remark in schedule.doc_remark.all %}
                                                                           <hr style="margin:0rem 0rem;">
                                                                           <div style="margin-left:1rem; margin-bottom:0rem;">
                                                                              {% if remark.remark_seen == True %}
                                                                              <i style='font-size:12px' class='fas'>&#xf06e;</i>
                                                                              {% else %}
                                                                              <i style='font-size:12px' class='fas'>&#xf070;</i>
                                                                              {% endif %}
                                                                              <b>Dr.{{remark.author}}:</b>{{remark.text}}
                                                                           </div>
                                                                        {% empty %}
                                                                           <hr style="margin:0rem 0rem;">
                                                                           <p>No remarks yet..</p>
                                                                        {% endfor%}
                                                                        <hr style="margin:0rem 0rem;">                                                                           
                                                                     </div>
                                                                  </form>
                                                               </div>
                                                            </div>
                                                            <div class="modal-footer" style="padding-top: 0.5rem; padding-bottom: 0rem;">
                                                               <div class="form-group" style="margin-bottom: 0.5rem;">
                                                                  <button  class="btn btn-primary" id="notif-back-btn-{{forloop.counter}}" data-dismiss="modal" >Back</button>
                                                               </div>
                                                            </div>                                                  
                                                         {% endif %}
                                                      {% endfor %}
                                                   {% endif %}
                                                {% endif %}
                                             </div>
                                          </div>
                                       </div>

                                       <script>
                                          $('#notif-row-{{forloop.counter}}').click(function(e){
                                             console.log("notif clicked!");
                                             e.preventDefault();

                                             // change UI to checked on notif clicked for quick changes
                                             if ($('#notif-checkbox-{{forloop.counter}}  input[type="checkbox"]').prop("checked") == false){ 
                                                alert("notif not changed to checked!");
                                             }else{
                                                $('#notif-checkbox-{{forloop.counter}}').prop('checked', true); 
                                                console.log("notif is changed to checked!");
                                             }

                                             // notif is read
                                             $.ajax({
                                                type:"POST",
                                                async:true,
                                                url:'{% url "docNotifRead" %}',
                                                data:{
                                                   csrfmiddlewaretoken: '{{ csrf_token }}', 
                                                   notif_pk: '{{docNotif.pk}}'
                                                },
                                                success:function(){
                                                   console.log("notif for doctor read" );
                                                }
                                             });

                                             if ('{{docNotif.subject}}' == "Appointment"){
                                                console.log("notif is schedule request.");
                                                $.ajax({
                                                   type:"POST",
                                                   async:true,
                                                   url:'/addSeen/',
                                                   data:{
                                                      csrfmiddlewaretoken: '{{ csrf_token }}',
                                                      viewed_type: "Consultation Schedule",
                                                      file_pk: '{{docNotif.action_pk}}',
                                                      file_owner: '{{docNotif.patient_username}}'
                                                   },
                                                   success:function(){
                                                      console.log("add doctor seen success: " + $('#medhist-viewed-owner-{{forloop.counter}}').val());
                                                   }
                                                });
                                             }
                                             else if ('{{docNotif.subject}}' == "ICR Form"){
                                                console.log("notif is schedule request.");
                                                $.ajax({
                                                   type:"POST",
                                                   async:true,
                                                   url:'/addSeen/',
                                                   data:{
                                                      csrfmiddlewaretoken: '{{ csrf_token }}',
                                                      viewed_type: "ICR",
                                                      file_pk: '{{docNotif.action_pk}}',
                                                      file_owner: '{{docNotif.patient_username}}'
                                                   },
                                                   success:function(){
                                                      console.log("ICR notif seen success: " + $('#medhist-viewed-owner-{{forloop.counter}}').val());
                                                   }
                                                });
                                             }
                                          });
                                        </script>

                                       {% empty %}
                                       <tr>
                                          <td>
                                            ...
                                          </td>
                                          <td>
                                            No notifications to show
                                          </td>
                                          <td class="text-right">
                                            ...
                                          </td>
                                       </tr>
                                    {% endfor %}
                                 </tbody>
                              </table>
                           </div>
                        </div>
                     </div>
                  </div>
               </div>
               <!-- END OF NOTIFICATIONS TAB -->


               <!-- STATISTICAL DATA OF PATIENTS -->
               <div  class="tab-pane fade py-5" id="stats" role="tabpanel" aria-labelledby="v-pills-fitness-tab" >
                  <div class="col-md-12" id="chart-container" style="border-style: ridge;"> 
                     <div class="card card-plain"  style="padding-top: 1.5rem;">
                        <div class="card-header" style="border:1px solid rgba(0, 0, 0, 0.125);">
                           <h4 class="card-title">Patients Handled Statistics 
                              <a> 
                                 <i class="fa fa-download" id="download-stat-btn" style="margin-left: 56%;" data-toggle="modal" data-target="#download-stat-doc">
                                 </i>
                              </a>
                           </h4>
                        </div>
                        <div class="card-body" style="margin-bottom: 1rem;">
                           
                           <div class="stat-content">
                              <div class="row"  style="margin-bottom:2rem;">
            
                                 <div class="col-lg-3 col-md-6 col-sm-6">
                                    <div class="card card-stats" style="max-width: 158px;">
                                       <div class="card-header" style="padding:0.5rem; background-color: #ffb3b3;">
                                          <p style="padding:0rem; margin:0rem;font-size: 14.5px;">For Screening</p>
                                       </div>
                                       <div class="card-body" style="padding:0px; text-align:center; ">
					  {% if doctor.p_handled_stats.doc_patients_count == 0 %}
                                             <div id="no-patients1" style="height: 180px; width:100%;"></div>
                                          {% endif %}
                                          {% if doctor.p_handled_stats.doc_patients_count != 0 %}
                                             <div id="for-screening-patients" style="height: 180px; width:100%;"></div>
                                          {% endif %}
                                       </div>
                                    </div>
                                 </div>
         
                                 <div class="col-lg-3 col-md-6 col-sm-6">
                                    <div class="card card-stats"  style="max-width: 158px;">
                                       <div class="card-header" style="padding:0.5rem; background-color: #ff9999;">
                                          <p  style="padding:0rem; margin:0rem;font-size: 14.5px;">Stage 1 HIV Patients</p>
                                       </div>
                                       <div class="card-body" style="padding:0rem; text-align:center;">
                                          {% if doctor.p_handled_stats.doc_patients_count == 0 %}
                                             <div id="no-patients2" style="height: 180px; width:100%;"></div>
                                          {% endif %}
                                          {% if doctor.p_handled_stats.doc_patients_count != 0 %}
						<div id="stage1-patients" style="height: 180px; width:100%;"></div>
					  {% endif %}
                                       </div>
                                    </div>
                                 </div>
         
                                 <div class="col-lg-3 col-md-6 col-sm-6">
                                    <div class="card card-stats"  style="max-width: 158px;">
                                       <div class="card-header" style="padding:0.5rem; background-color: #ff8080;">
                                          <p  style="padding:0rem; margin:0rem;font-size: 14.5px;">Stage 2 HIV Patients</p>
                                       </div>
                                       <div class="card-body" style="padding:0rem; text-align:center;">
					  {% if doctor.p_handled_stats.doc_patients_count == 0 %}
                                             <div id="no-patients3" style="height: 180px; width:100%;"></div>
                                          {% endif %}
                                          {% if doctor.p_handled_stats.doc_patients_count != 0 %}
                                             <div id="stage2-patients" style="height: 180px; width:100%;"></div>
					  {%endif%}
                                       </div>
                                    </div>
                                 </div>
         
                                 <div class="col-lg-3 col-md-6 col-sm-6">
                                    <div class="card card-stats" style="max-width:158px;">
                                       <div class="card-header" style="padding:0.5rem; background-color: #ff6666;">
                                          <p  style="padding:0rem; margin:0rem;font-size: 14.5px;">Stage 3 HIV Patients</p>
                                       </div>
                                       <div class="card-body" style="padding:0rem; text-align:center;">
					  {% if doctor.p_handled_stats.doc_patients_count == 0 %}
                                             <div id="no-patients4" style="height: 180px; width:100%;"></div>
                                          {% endif %}
                                          {% if doctor.p_handled_stats.doc_patients_count != 0 %}
                                             <div id="stage3-patients" style="height: 180px; width:100%;"></div>
					  {%endif%}
                                       </div>
                                    </div>
                                 </div>
         
                              </div>
            
                                 <!-- BAR GRAPH  -->
                                 <div class="row"  style="margin-bottom:2rem;">
                                    <div class="col-md-12">
                                       <div class="card ">
                                          <div class="card-header ">
                                             <h5 class="card-title">Monthly Statistics</h5>
                                             <p> Select Year:
                                                <select  style="height:30px; line-height:30px;" id="stat-year-choice"  readonly>
                                                   <option value="2020">2020</option>
                                                   <option value="2021">2021</option>
                                                   <option value="2019">2019</option>
                                                </select>
                                             </p>
                                          </div>
                                          <div class="card-body " style="padding:0px;">
                                             <div id="chartContainer" style="display: block;height:230px; width:728px;" width="400" height="100"></div>
                                          </div>
                                       </div>
                                    </div>
                                 </div>
                           </div> 
                        </div>
                     </div>
                  </div>        
               </div>

               <script>
                  // get the chosen stat year and reflect in stats tab
                  $('#stat-year-choice').on('change', function() {
                     statYear = $('#stat-year-choice').val();
                     var columnChart2;
                     var yearFound = false;
                     for(let i=0; i<1; i++){
                        {% for p_stat in patients_stats %}
                           var all_p_stat_year = '{{p_stat.year}}';
                           if (all_p_stat_year == statYear){
                              {% for stat in doctor.p_handled_stats.monthly_stats.all %}
                                 pStat = '{{stat.year}}';
                                 if (pStat == statYear){
                                    yearFound = true;
                                    console.log('{{stat.year}} : {{stat.pk}}');

					//assign to another variable for tweaking
					//all patient
       					var chosen_other_patients_jan = {{p_stat.january}};
        				var chosen_other_patients_feb = {{p_stat.february}};// + other_patients_jan;
        				var chosen_other_patients_mar = {{p_stat.march}};// + other_patients_feb;
        				var chosen_other_patients_apr = {{p_stat.april}};// +  other_patients_mar;
       					var chosen_other_patients_may = {{p_stat.may}};// +  other_patients_apr;
        				var chosen_other_patients_jun = {{p_stat.june}};// +  other_patients_may;
        				var chosen_other_patients_jul = {{p_stat.july}};// +  other_patients_jun;
        				var chosen_other_patients_aug = {{p_stat.august}};// +  other_patients_jul;
        				var chosen_other_patients_sep = {{p_stat.september}};// +  other_patients_aug;
        				var chosen_other_patients_oct = {{p_stat.october}};// +  other_patients_sep;
        				var chosen_other_patients_nov = {{p_stat.november}};// +  other_patients_oct;
        				var chosen_other_patients_dec = {{p_stat.december}};// +  other_patients_nov;


        				//doctor patients
        				var chosen_doc_patients_jan = {{stat.january}};
        				var chosen_doc_patients_feb = {{stat.february}};// + doc_patients_jan;
        				var chosen_doc_patients_mar = {{stat.march}};// + doc_patients_feb;
       	 				var chosen_doc_patients_apr = {{stat.april}};// + doc_patients_mar;
        				var chosen_doc_patients_may = {{stat.may}};// + doc_patients_apr;
        				var chosen_doc_patients_jun = {{stat.june}};// + doc_patients_may;
        				var chosen_doc_patients_jul = {{stat.july}};// + doc_patients_jun;
        				var chosen_doc_patients_aug = {{stat.august}};// + doc_patients_jul;
        				var chosen_doc_patients_sep = {{stat.september}};// + doc_patients_aug;
        				var chosen_doc_patients_oct = {{stat.october}};// + doc_patients_sep;
        				var chosen_doc_patients_nov = {{stat.november}};// + doc_patients_oct;
				        var chosen_doc_patients_dec = {{stat.december}};// + doc_patients_nov;

					//get the total patients per month
        				var chosen_latest_monthly_patient_count = [chosen_other_patients_jan, chosen_other_patients_feb, chosen_other_patients_mar, chosen_other_patients_apr, chosen_other_patients_may, chosen_other_patients_jun, chosen_other_patients_jul, chosen_other_patients_aug, chosen_other_patients_sep, chosen_other_patients_oct, chosen_other_patients_nov, chosen_other_patients_dec];
        				var chosen_all_patients_monthly_count = [chosen_doc_patients_jan, chosen_doc_patients_feb, chosen_doc_patients_mar, chosen_doc_patients_apr, chosen_doc_patients_may, chosen_doc_patients_jun, chosen_doc_patients_jul, chosen_doc_patients_aug, chosen_doc_patients_sep, chosen_doc_patients_oct, chosen_doc_patients_nov, chosen_doc_patients_dec];
        				var chosen_curr_date = new Date();
        				var chosen_curr_month = chosen_curr_date.getMonth(); //gets the current numeric month 0-based
        				let i = 0;


				        while (i < chosen_curr_month){
                				if (i+1 < 13){
                        				//console.log(a + " before: " +  latest_monthly_patient_count[a]);
                        				chosen_latest_monthly_patient_count[i+1]+=chosen_latest_monthly_patient_count[i];
                        				//console.log(a + " after: " +  chosen_latest_monthly_patient_count[i+1]);
                        				chosen_all_patients_monthly_count[i+1]+=chosen_all_patients_monthly_count[i];
                        				console.log(chosen_all_patients_monthly_count[i] + " :: " + chosen_latest_monthly_patient_count[i]);
                        				if (chosen_all_patients_monthly_count[i] < chosen_latest_monthly_patient_count[i]){
                                				console.log(i + " before: " + chosen_all_patients_monthly_count[i] + " -- " +  chosen_latest_monthly_patient_count[i]);
                                				chosen_latest_monthly_patient_count[i]-=chosen_all_patients_monthly_count[i];
                                				console.log(i + " after: " + chosen_all_patients_monthly_count[a] + " -- " +  chosen_latest_monthly_patient_count[i]);
                        				}
                        				i++;
                			}
       				   }

				   chosen_latest_monthly_patient_count[curr_month]-=chosen_all_patients_monthly_count[curr_month];


                                    columnChart2 = new CanvasJS.Chart("chartContainer", {
                                       animationEnabled: true, 	
                        
                                       axisY:{
                                          title: 'Number of Patients',
                                          gridColor: "rgba(1,77,101,.1)",
                                       },
                                       axisX:{
                                          title: 'Year {{stat.year}}',
                                          interval: 1
                                       },
                                       data: [
                                       {
                                          type: "stackedColumn",
                                          showInLegend: true,
                                          indexLabel: "{y}",
                                          indexLabelPlacement: "inside",
                                          indexLabelFontSize: 15,
                                          indexLabelFontWeight: "bolder",
                                          color: "#f27961",
                                          name: "Your Patients",
                                          dataPoints: [
                                          
                                             { label: "January",  y: chosen_all_patients_monthly_count[0] },
                                             { label: "February", y: chosen_all_patients_monthly_count[1]  },
                                             { label: "March", y: chosen_all_patients_monthly_count[2]  },
                                             { label: "April",  y: chosen_all_patients_monthly_count[3] },
                                             { label: "May",  y: chosen_all_patients_monthly_count[4] },
                                             { label: "June",  y: chosen_all_patients_monthly_count[5]  },
                                             { label: "July",  y: chosen_all_patients_monthly_count[6]  },
                                             { label: "August",  y: chosen_all_patients_monthly_count [7]  },
                                             { label: "September",  y: chosen_all_patients_monthly_count[8] },
                                             { label: "October",  y: chosen_all_patients_monthly_count[9]  },
                                             { label: "November",  y: chosen_all_patients_monthly_count[10]  },
                                             { label: "December",  y: chosen_all_patients_monthly_count[11] },
                                          
                                          ]
                                       },
                                       {
                                          type: "stackedColumn",
                                          showInLegend: true,
                                          indexLabel: "{y}",
                                          indexLabelPlacement: "inside",
                                          indexLabelFontSize: 15,
                                          indexLabelFontWeight: "bolder",
                                          name: "Other Patients",
                                          color: "#20e007", 
                                          dataPoints: [
                                             { label: "January",  y: chosen_latest_monthly_patient_count[0] },
                                             { label: "February", y: chosen_latest_monthly_patient_count[1] },
                                             { label: "March", y: chosen_latest_monthly_patient_count[2] },
                                             { label: "April",  y: chosen_latest_monthly_patient_count[3] },
                                             { label: "May",  y: chosen_latest_monthly_patient_count[4]  },
                                             { label: "June",  y: chosen_latest_monthly_patient_count[5] },
                                             { label: "July",  y: chosen_latest_monthly_patient_count[6]  },
                                             { label: "August",  y: chosen_latest_monthly_patient_count[7]  },
                                             { label: "September",  y: chosen_latest_monthly_patient_count[8]  },
                                             { label: "October",  y: chosen_latest_monthly_patient_count[9]  },
                                             { label: "November",  y: chosen_latest_monthly_patient_count[10]  },
                                             { label: "December",  y:  chosen_latest_monthly_patient_count[11] },
                                          ]
                                       },
                                       ]
                                    });
                                    columnChart2.render();
                                 
                                    // update the data to be downloaded //get it ready just in case, it will be downloaded
                                    $("#stat-label").text("{{stat.year}})");
                                    $("#d-jan").text("{{stat.january}}");
                                    $("#d-feb").text("{{stat.february}}");
                                    $("#d-mar").text("{{stat.march}}");
                                    $("#d-apr").text("{{stat.april}}");
                                    $("#d-may").text("{{stat.may}}");
                                    $("#d-jun").text("{{stat.june}}");
                                    $("#d-jul").text("{{stat.july}}");
                                    $("#d-aug").text("{{stat.august}}");
                                    $("#d-sep").text("{{stat.september}}");
                                    $("#d-oct").text("{{stat.october}}");
                                    $("#d-nov").text("{{stat.november}}");
                                    $("#d-dec").text("{{stat.december}}");
                                    break;
                                    }
                                 {% endfor %}
                              }
                           {% endfor %}
                           }

                     if (!yearFound){
                        columnChart2 = new CanvasJS.Chart("chartContainer", {
                           // theme: "light2", // "light2", "dark1", "dark2"
                        animationEnabled: true, // change to true		
         
                        axisY:{
                           title: 'Number of Patients',
                           gridColor: "rgba(1,77,101,.1)",
                        },
                        axisX:{
                           title: 'Year ' + statYear,
                           interval: 1
                        },
                        data: [
                           {
                              type: "stackedColumn",
                              showInLegend: true,
                              color: "#f27961",
                              name: "Your Patients",
                              dataPoints: [
                              
                                 { label: "January",  y:0 },
                                 { label: "February", y: 0  },
                                 { label: "March", y: 0  },
                                 { label: "April",  y: 0 },
                                 { label: "May",  y: 0 },
                                 { label: "June",  y: 0 },
                                 { label: "July",  y: 0  },
                                 { label: "August",  y: 0  },
                                 { label: "September",  y: 0  },
                                 { label: "October",  y: 0  },
                                 { label: "November",  y: 0  },
                                 { label: "December",  y:  0 },
                              
                              ]
                           },
                           {
                              // Change type to "bar", "area", "spline", "pie",etc.
                              type: "stackedColumn",
                              showInLegend: true,
                              name: "Other Patients",
                              color: "#20e007", 
                              dataPoints: [
                                 { label: "January",  y:0 },
                                 { label: "February", y: 0  },
                                 { label: "March", y: 0  },
                                 { label: "April",  y: 0 },
                                 { label: "May",  y: 0 },
                                 { label: "June",  y: 0 },
                                 { label: "July",  y: 0  },
                                 { label: "August",  y: 0  },
                                 { label: "September",  y: 0  },
                                 { label: "October",  y: 0  },
                                 { label: "November",  y: 0  },
                                 { label: "December",  y:  0 },
                              ]
                           },
                        ]
                        });
                        columnChart2.render();
                        
                        // update the data to be downloaded //get it ready just in case, it will be downloaded
                        $("#stat-label").text(statYear);
                        $("#d-jan").text("0");
                        $("#d-feb").text("0");
                        $("#d-mar").text("0");
                        $("#d-apr").text("0");
                        $("#d-may").text("0");
                        $("#d-jun").text("0");
                        $("#d-jul").text("0");
                        $("#d-aug").text("0");
                        $("#d-sep").text("0");
                        $("#d-oct").text("0");
                        $("#d-nov").text("0");
                        $("#d-dec").text("0");
                     }
                  });
               </script>
                 
               <!-- modal to input password before download -->
               <div class="modal fade" id="download-stat-doc" tabindex="-1" role="dialog" aria-hidden="true">
                  <div class="modal-dialog" role="document">
                     <div class="modal-content" id="modal-content-stat">
                        <div class="modal-header" style="background-color: #802400;">
                           <h5 class="modal-title" id="modal-title-stat" style="color:#ffffff;"> Enter password</h5>
                           <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                           <span aria-hidden="true">&times;</span>
                           </button>
                        </div>   
                        <div class="modal-body"  style="font-size:12px;">
                           <div id="download-type-wrapper">
                              <p style="margin-left:0rem; font-family: Montserrat;">Download as:
                                 <select id="download-type" >
                                    <option value="graph">graph</option>
                                    <option value="text">text</option>
                                 </select>
                              </p>
                           </div>
                           <input type="password" required id="ps-verify-stat">
                           <span id='p_password_message_stat'></span>
                         
                           <!-- content to be downloaded -->
                           <div hidden id="stat-download-content" style="border: 1px solid lightgrey;margin-top: 1rem; font-family: Montserrat;">
                                                                                        
                                 <h3><b>Patients Handled Statistics</b></h3>
                                 <p style="margin-left:0rem;">Start Date: {{doctor.p_handled_stats.start_date}}</p> 
                                 <p style="margin-left:0rem;">Last Updated: {{doctor.p_handled_stats.monthly_stats.latest.created_on}}</p>  
                                 <p style= "margin-left:0rem;">Doctor Name: {{doctor.p_handled_stats.doctor_name}}</p>
                                 <br>
                                 <p style="margin-left:0rem;"><b>1. Patients Handled Summary </b>(All Patients Handled)</p>
                                 <p style= "padding-left:10px;padding-top:10px;margin-left:4rem;"><b>Negative Patients: </b> {{doctor.p_handled_stats.neg_patients}}</p>
                                 <p style= "padding-left:10px;padding-top:10px;margin-left:4rem;"><b>For Screening Patients: </b> {{doctor.p_handled_stats.for_screening}}</p>
                                 <p style= "padding-left:10px;padding-top:10px;margin-left:4rem;"><b>HIV Stage 1 Patients:</b> {{doctor.p_handled_stats.stage_1}}</p>
                                 <p style= "padding-left:10px;padding-top:10px;margin-left:4rem;"><b>HIV Stage 2 Patients:</b> {{doctor.p_handled_stats.stage_2}}</p>
                                 <p style= "padding-left:10px;padding-top:10px;margin-left:4rem;"><b>HIV Stage 3 Patients:</b> {{doctor.p_handled_stats.stage_3}}</p>                                                   
                                 <p style= "padding-left:10px;padding-top:10px;margin-left:4rem;"><b>Doctor's Total Patients:</b> {{doctor.p_handled_stats.doc_patients_count}}</p>                                                  
                                 <p style= "padding-left:10px;padding-top:10px;margin-left:4rem;"><b>All Patients:</b> {{doctor.p_handled_stats.all_patients_count}}</p> 
                                 <br>
                                 <p  style="margin-left:0rem;"><b>2. Monthly Statistics </b>(Number of patients handled monthly since January <a id="stat-label"> </a>) </p>
                                 <p   style="margin-left:4rem;"><b>January: </b> <a  id="d-jan"></a></p>
                                 <p style="margin-left:4rem;"><b>February: </b> <a  id="d-feb"></a></p>
                                 <p style="margin-left:4rem;"><b>March: </b> <a id="d-mar" ></a></p>
                                 <p style="margin-left:4rem;"><b>April: </b> <a   id="d-apr"></a></p>
                                 <p  style="margin-left:4rem;"><b>May: </b> <a id="d-may"></a></p>
                                 <p  style="margin-left:4rem;"><b>June: </b> <a id="d-jun"></a></p>
                                 <p  style="margin-left:4rem;"><b>July: </b> <a id="d-jul"></a></p>
                                 <p  style="margin-left:4rem;"><b>August: </b> <a id="d-aug"></a></p>
                                 <p  style="margin-left:4rem;"><b>September: </b> <a id="d-sep"></a></p>
                                 <p style="margin-left:4rem;"><b>October: </b> <a id="d-oct" ></a></p>
                                 <p  style="margin-left:4rem;"><b>November: </b> <a id="d-nov"></a></p>
                                 <p  style="margin-left:4rem;"><b>December: </b> <a id="d-dec"></a></p>

                                 <p>>>>>>>>>>>>>> Nothing Follows >>>>>>>>>>>>>>>>></p>

                           </div>
                        </div>
                        <div id="stateditor"></div>
                        <div class="modal-footer">
                           <button disabled  class="btn btn-primary"  data-dismiss="modal" id="download_btn_stat" >Continue Download</button>
                           <button  class="btn btn-primary"  data-dismiss="modal">Back</button>
                        </div>
                     </div>
                  </div>
               </div>

               <script>
                   // input password before download
                  $('#ps-verify-stat').on('keyup', function () {
                     if ($('#ps-verify-stat').val() != ''){
                        if ($('#ps-verify-stat').val() == "{{doctor.password}}" ) {
                           $('#p_password_message_stat').html('Correct Password').css('color', 'green');
                              $("#download_btn_stat").removeAttr('disabled');
                        }else{
                           $('#p_password_message_stat').html('Incorrect Password').css('color', 'red');
                           $("#download_btn_stat").attr("disabled", true);
                        }
                     }
                  });

                  // download medhist of patient.
                  var statdoc = new jsPDF();
                  var specialElementHandlers = {
                     '#stateditor': function (element, renderer) {
                        return true;
                     }
                  };

                  $('#download_btn_stat').click(function () {
                     var downloadType= $('#download-type').val();
                     var statFooter;

                     if (downloadType == "graph"){
                        html2canvas(document.getElementById("chart-container"), {
                           onrendered: function(canvas) {
                              var img = canvas.toDataURL(); //image data of canvas
                              var doc = new jsPDF();
                              doc.addImage(img, 10, 20, 190, 200);

                              //footer
                              var date_now = new Date();
                              statFooter = "Start Date: {{doctor.p_handled_stats.start_date}}" + "\n" +
                                             "Last Updated: {{doctor.p_handled_stats.monthly_stats.latest.created_on}}" + "\n" + 
                                             "Dr.{{doctor.name}} patients data as of: " + date_now.toDateString() + "\n\n" +
                                             "-------------------------------------------------------------------------------------------------" + "\n" +
                                             "Page 1 of 1"  ;
                              var pageSize = doc.internal.pageSize;
                              var pageHeight = pageSize.height ? pageSize.height : pageSize.getHeight();
                              doc.text(statFooter, 10, pageHeight - 40);
                              
                              doc.save('graph-stat-{{doctor.name}}.pdf'); //a4 size
                           }
                        });
                     }
                     else if (downloadType == "text"){
                        statdoc.fromHTML($('#stat-download-content').html(), 15, 15, {
                           'width': 170,
                                 'elementHandlers': specialElementHandlers
                        });
                        statFooter = "Page 1 of 1";
                        var pageSize = doc.internal.pageSize;
                        var pageHeight = pageSize.height ? pageSize.height : pageSize.getHeight();
                        statdoc.text(statFooter, 10, pageHeight - 7);
                        statdoc.save('text-stat-{{doctor.name}}.pdf');
                     }
                  });        
               </script>     
         

               <!-- PATIENTS LIST -->
               <div class="tab-pane fade py-5"  id="patients" role="tabpanel" aria-labelledby="v-pills-fitness-tab">
                  <div class="col-md-12" style="border-style: ridge;"> 
                     <div class="card card-plain"  style="padding-top: 1.5rem;">
                        <div class="card-header" style="border:1px solid rgba(0, 0, 0, 0.125);">
                           <h4 class="card-title">Patients List</h4><a style="color:grey; font: 12px;">total patients: {{patients|length}}</a>
                        </div>
                        <div class="card-body" style="margin-bottom: 1rem;">
                           {% for patient in patients %}
                              <div class="list-group item" id="list-item-{{patient.first_name}}"> 
                                 <div class="form-group" id="form-group-{{patient.first_name}}"> 
                                    <p  class="collapsible" style="margin-bottom:0rem; margin-left:0rem;" id="patient-name-{{patient.first_name}}" name="patient-name" onclick="openDetails(event, 'profile-content-{{patient.first_name}}')">
                                       <span style="position:absolute;margin-left:660px;">   
                                          <span class="dot"></span>
                                          <span class="dot"></span>
                                          <span class="dot"></span>
                                       </span>                                          
                                       {{forloop.counter}}. {{patient.username}}
                                    </p>
                                    
                                    <div class="content" style="font-size: small" id="content-{{patient.first_name}}" >
                                       <div class="patient-details-tab" id="{{patient.first_name}}-tab">
                                          <form id="seen-profile-{{patient.username}}" onsubmit="return false;">   <!--profile is marked seen upon button click -->
                                             {% csrf_token %}
                                             <input hidden class="profile_viewed_type" id="profile-viewed-type-{{forloop.counter}}" name="viewed_type_profile" value="Public Profile">
                                             <input hidden class="profile_viewed_pk" id="profile-viewed-pk-{{forloop.counter}}" name="file_pk_profile" type="number" value="{{patient.pk}}">
                                             <input hidden class="profile_file_owner" id="profile-viewed-owner-{{forloop.counter}}" name="file_owner_profile"  value="{{patient.username}}">
                                             
                                             <button type="submit" class="tablinks" id="profile-btn-{{patient.first_name}}" onclick="openDetails(event, 'profile-content-{{patient.first_name}}')">Public Profile</button>
                                          </form>

                                          <form id="seen-medhist-{{patient.username}}" onsubmit="return false;">   <!--medhist is marked seen upon button click -->
                                             {% csrf_token %}
                                             <input hidden class="medhist_viewed_type" id="medhist-viewed-type-{{forloop.counter}}" name="viewed_type_medhist" value="Medical History">
                                             <input hidden class="medhist_viewed_pk" id="medhist-viewed-pk-{{forloop.counter}}" name="file_pk_medhist" type="number" value="{{patient.pk}}">
                                             <input hidden class="medhist_file_owner" id="medhist-viewed-owner-{{forloop.counter}}" name="file_owner_medhist"  value="{{patient.username}}">
                                             
                                             <button type="submit" class="tablinks" id="med-hist-btn-{{patient.first_name}}" onclick="openDetails(event, 'med-hist-content-{{patient.first_name}}')">Medical History</button>
                                          </form>
                                          
                                          <form id="seen-icr-{{patient.username}}" onsubmit="return false;">
                                             <input hidden class="icr_viewed_type" id="icr-viewed-type-{{forloop.counter}}" name="viewed_type-icr" value="ICR">
                                             <input hidden class="icr_viewed_pk" id="icr-viewed-pk-{{forloop.counter}}" name="file_pk-icr" type="number" value="{{patient.pk}}">
                                             <input hidden class="icr_file_owner" id="icr-viewed-owner-{{forloop.counter}}" name="file_owner-icr"  value="{{patient.username}}">
                                             <button type="submit" class="tablinks" id="icr-form-btn-{{patient.first_name}}" onclick="openDetails(event, 'icr-form-content-{{patient.first_name}}')">ICR Form</button>
                                          </form>

                                          <button type="button" class="tablinks" id="p-record-btn-{{patient.first_name}}" onclick="openDetails(event, 'p-record-content-{{patient.first_name}}')">Personal Journal</button>
                                          <button type="button" class="tablinks" id="p-arv-btn-{{patient.first_name}}" onclick="openDetails(event, 'p-art-content-{{patient.first_name}}')">Antiretroviral (ART) Medications</button>                                         
                                       </div>

                                       <script>
                                          // upon name click, make profile tab active
                                          $('#patient-name-{{patient.first_name}}').click(function(){
                                             $('#profile-btn-{{patient.first_name}}').addClass('active');
                                          }); 

                                            $('#med-hist-btn-{{patient.first_name}}').click(function(e){
                                                console.log("action: Medical History");
                                                e.preventDefault();

                                                   $.ajax({
                                                      type:"POST",
                                                      async:true,
                                                      url:'/addSeen/',
                                                      data:{
                                                         csrfmiddlewaretoken: '{{ csrf_token }}', 
                                                         viewed_type: $('#medhist-viewed-type-{{forloop.counter}}').val(),
                                                         file_pk: $('#medhist-viewed-pk-{{forloop.counter}}').val(),
                                                         file_owner: $('#medhist-viewed-owner-{{forloop.counter}}').val()
                                                      },
                                                      success:function(){
                                                         console.log("add doctor seen success: " + $('#medhist-viewed-owner-{{forloop.counter}}').val());
                                                      }
                                                   });                                                
                                             });

                                             $('#prof-form-btn-{{patient.first_name}}').click(function(e){
                                                console.log("action: Profile Form");
                                                e.preventDefault();

                                                   $.ajax({
                                                      type:"POST",
                                                      async:true,
                                                      url:'/addSeen/',
                                                      data:{
                                                         csrfmiddlewaretoken: '{{ csrf_token }}', 
                                                         viewed_type: $('#prof-viewed-type-{{forloop.counter}}').val(),
                                                         file_pk: $('#prof-viewed-pk-{{forloop.counter}}').val(),
                                                         file_owner: $('#prof-viewed-owner-{{forloop.counter}}').val()
                                                      },
                                                      success:function(){
                                                         console.log("add doctor seen success: " + $('#prof-viewed-owner-{{forloop.counter}}').val());
                                                      }
                                                   });                                                
                                             });
                                             
                                             $('#icr-form-btn-{{patient.first_name}}').click(function(e){
                                                console.log("action: ICR");
                                                e.preventDefault();

                                                $.ajax({
                                                   type:"POST",
                                                   async:true,
                                                   url:'/addSeen/',
                                                   data:{
                                                      csrfmiddlewaretoken: '{{ csrf_token }}', 
                                                      viewed_type: $('#icr-viewed-type-{{forloop.counter}}').val(),
                                                      file_pk: $('#icr-viewed-pk-{{forloop.counter}}').val(),
                                                      file_owner: $('#icr-viewed-owner-{{forloop.counter}}').val()
                                                   },
                                                   success:function(){
                                                      console.log("add doctor seen success: " + $('#icr-viewed-owner-{{forloop.counter}}').val());
                                                   }
                                                });                                                
                                             });
                                       </script>


                                        <!-- class for profile is changed similar to root tabs to accomodate being active -->
                                        <div class="patient-tab-content tab-pane fade show active" style="padding: 6px 0px; border: 1px solid #ccc;border-top: none;" id="profile-content-{{patient.first_name}}">
                                          <div id="patient-profile-basic-info">
                                             <div class="patient-pic">
                                                
                                                {% if patient.patient_image %}
                                                   <img src="{{patient.patient_image.url}}" style="max-width:200px; max-height:300px; " > 
                                                {% endif %}
                                                {% if not patient.patient_image %}
                                                   <img src="{% static 'portal/images/user.png' %}"  style="max-width:200px; max-height:300px; " > 
                                                {% endif %}
                                             </div>
                                             <div class="patient-info">
                                                <div id="patient-prof-editablewrapper-{{patient.pk}}" style="margin-left:1rem;">
                                                   <p hidden style="color:lightcoral; margin:0rem; margin-top:0.3rem;"><b>Address: </b> 
                                                      <input readonly id="patient-status-add-{{patient.username}}" value="{{patient.present_address}}">
                                                   </p>
                                                   <p style="color:lightcoral; margin:0rem; margin-top:0.3rem;"> <b>Status:</b>
                                                      <input readonly id="patient-curr-stat-{{patient.pk}}" value="{{patient.status}}">
                                                      <select style="display:none;" class="med-hist-field" id="patient-status-choice-{{patient.pk}}" value="{{patient.HIV_status}}">
                                                         <option value="ongoing therapy">ongoing therapy</option>
                                                         <option value="deceased">deceased</option>
                                                      </select>
                                                   </p>
                                                </div>
                                                
                                                <p> <b>Location:</b>
                                                   {{patient.location_details.latest.general_location}}                                              
                                                </p>
                                                <p><b>Username: </b>{{patient.username}}</p>
                                                <p><b>Age: </b>{{patient.age}}</p>
                                                <p><b>HIV Level: </b>{{patient.HIV_status}}</p>
                                                <p><b>Work: </b>{{patient.work}}</p>  
                                                <p><b>Email: </b>{{patient.email}}</p>   
                                                <p><b>Contact Number: </b>{{patient.call_number}}</p>

                                                <button class="btn btn-primary" id="back-btn-pstatus-{{patient.username}}" style="display:none; margin-left:1rem; margin-top:1rem; font-size:12px;" >Back</button>
                                                <button class="btn btn-primary" id="change-p-stat-{{patient.pk}}"  style="margin-left:1rem; margin-top:1rem; font-size:12px;" >Change Patient Status</button> 
                                                <button  class="btn btn-primary" id="save-p-stat-{{patient.pk}}" style="display:none; font-size:12px; margin-top:1rem;" >Save</button> 
                                             
                                             </div>
                                             <div id="clear"></div>
                                          
                                          </div>
                                       </div>

                                       <script>

                                          $('#change-p-stat-{{patient.pk}}').click(function(){
                                             $('#patient-curr-stat-{{patient.pk}}').hide();
                                             $('#patient-status-choice-{{patient.pk}}').show();
                                             $('#save-p-stat-{{patient.pk}}').show();
                                             $('#change-p-stat-{{patient.pk}}').hide();     
                                             
                                             $('#back-btn-pstatus-{{patient.username}}').show();   
                                             $('#patient-curr-gen-loc-{{patient.pk}}').hide(); 
                                             $('#patient-status-add-{{patient.username}}').removeAttr('readonly');
                                          });

                                          $('#back-btn-pstatus-{{patient.username}}').click(function(){
                                             $('#patient-curr-stat-{{patient.pk}}').show();
                                             $('#patient-status-choice-{{patient.pk}}').hide();
                                             $('#save-p-stat-{{patient.pk}}').hide();
                                             $('#change-p-stat-{{patient.pk}}').show();
                                             $('#back-btn-pstatus-{{patient.username}}').hide();  
                                             $('#patient-curr-gen-loc-{{patient.pk}}').show(); 
                                             $('#patient-status-add-{{patient.username}}').attr('readonly', true);

                                          });

                                          $('#save-p-stat-{{patient.pk}}').click(function(){
                                             $('#patient-curr-stat-{{patient.pk}}').show();
                                             $('#patient-status-choice-{{patient.pk}}').hide();
                                             $('#save-p-stat-{{patient.pk}}').hide();
                                             $('#change-p-stat-{{patient.pk}}').show();
                                             $('#back-btn-pstatus-{{patient.username}}').hide();  
                                             $('#patient-curr-gen-loc-{{patient.pk}}').show(); 
                                             $('#patient-status-add-{{patient.username}}').attr('readonly', true);

                                             $.ajax({
                                                type: "POST",
                                                async: true,
                                                url: '{% url "updatePStat" %}',
                                                data:{
                                                   csrfmiddlewaretoken: '{{ csrf_token }}',
                                                   patient_pk: '{{patient.pk}}',
                                                   patient_add: $('#patient-status-add-{{patient.username}}').val(),
                                                   p_stat: $('#patient-status-choice-{{patient.pk}}').val()
                                                },
                                                success:function(){
                                                   alert("patient status added! Refresh to view changes.")
                                                }
                                             });
                                          });
                                       </script>

                                       <!-- class for med hist is changed similar to root tabs to accomodate being active -->
                                       <div class="patient-tab-content tab-pane fade show active" style="padding: 6px 0px; border: 1px solid #ccc;border-top: none;" id="med-hist-content-{{patient.first_name}}">
                                          <form id="medhist-form-{{patient.username}}" method="post">
                                                {% csrf_token %}
                                                <input hidden name="medhist-patient-username" id="medhist-patient-username-{{patient.pk}}" value="{{patient.username}}">
                                                <p class="p-re">
                                                   <b>Code Name: </b>
                                                   <a style="font-size: 3;" id="patient-uname-{{patient.username}}" name="patient-uname">{{patient.username}}</a>
                                                </p>
                                                <p><b>Medical History</b> </p>
                                                <p>HIV Level: 
                                                   <input class="med-hist-field" id="hiv-level-{{patient.username}}" readonly value="{{patient.HIV_status}}">
                                                   <select style="display:none;" class="med-hist-field" id="hiv-choice-{{patient.username}}" value="{{patient.HIV_status}}">
                                                         <option value="for screening">for screening</option>
                                                         <option value="negative">negative</option>
                                                         <option value="stage 1">Stage 1</option>
                                                         <option value="stage 2">Stage 2</option>
                                                         <option value="stage 3">Stage 3 (AIDS)</option>
                                                   </select>
                                                </p>
                                                <p>Exposure: 
                                                   <input class="med-hist-field" id="exposure-{{patient.first_name}}" name="exposure" readonly value="{{patient.medical_history.latest.exposure}}">
                                                </p>
                                                <p>Other Medical Condition: 
                                                   <input style="width: auto;;" type="text" class="med-hist-field"  id="other-med-con-{{patient.first_name}}" name="other-med-con" readonly value="{{patient.medical_history.latest.other_conditions}}">
                                                </p>
                                                <p>Date Diagnosed/ Date Sample Sent for Confirmatory: 
                                                   <input class="med-hist-field" id="date-diagnosed-{{patient.first_name}}" name="date-diagnosed" readonly value="{{patient.medical_history.latest.date_diagnosed}}">
                                                   <input style="display:none;" type="date" class="med-hist-field" id="date-diagnosed-choices-{{patient.first_name}}" name="date-diagnosed-choices" value="{{patient.medical_history.latest.date_diagnosed}}">
                                                </p>
                                                <p style= "margin-bottom:0px; font-size: 12px; color:grey;">seen by: 
                                                   {% for viewer in patient.medical_history.latest.docs_viewed.all %}
                                                      {{viewer.viewer_name}} |
                                                   {% empty %}
                                                   ...
                                                   {% endfor %}
                                                </p>
                                                
                                                <hr style="border-top: 2px solid rgba(0, 0, 0, 0.1); margin-top:.5rem; margin-bottom:0px;">  
                                                <p class="doc-remarks-header"><b>Doctor(s) Remarks: </b></p>
                                                <hr style="margin-top:0.5rem;">
                                                <p style="margin-bottom: 0rem;"><b>Add a remark:</b> </p>
                                                <textarea class="med-hist-field"  style="margin-left:1rem;margin-top:0.5rem;"cols="50" rows="2" id="medhist-add-doc-remarks-{{forloop.counter}}" name="medhist-add-doc-remarks" readonly></textarea>                                                      
                                               
                                                <div id="medhist-remarks">
                                                   {% for remark in patient.medical_history.latest.doctor_remarks.all %}

                                                      <hr style="margin:0rem 0rem;">
                                                      <div style="margin-left:1rem; margin-bottom:0rem;">
                                                         {% if remark.remark_seen == True %}
                                                         <i style='font-size:12px' class='fas'>&#xf06e;</i>
                                                         {% else %}
                                                         <i style='font-size:12px' class='fas'>&#xf070;</i>
                                                         {% endif %}
                                                         <b>Dr.{{remark.author}}:</b>{{remark.text}}
                                                      </div>
                                                      
                                                   {% empty %}
                                                   <hr style="margin:0rem 0rem;">
                                                   <p>No remarks yet..</p>
                                                      
                                                   {% endfor%}
                                                </div>
                                                
                                                <hr style="margin:0rem;">
                                                <div class="form-group" style="margin:1rem;">       
                                                   <button  class="btn btn-primary" style="font-size:12px;"  id="download-med-hist-{{patient.username}}" name="download-med-hist" type="button" data-toggle="modal" data-target="#ps-ver-{{patient.username}}"><i class="fa fa-download"></i> Download</button>                                                   
                                                   <button style="font-size:12px; margin-left:1rem;" class="btn btn-primary" type="button" id="button1_{{patient.username}}" >Edit</button>
                                                   <button style="display:none; font-size:12px; margin-left:1rem;" class="btn btn-primary" type="button" id="back_btn_{{patient.username}}" >Back</button>
                                                   <button style="font-size:12px; display: none;" class="btn btn-primary" type="submit" id="button2_{{patient.username}}">Save</button>
                                                </div>
                                             </form>

                                              <!-- modal to input password before download -->
                                             <div class="modal fade" id="ps-ver-{{patient.username}}" tabindex="-1" role="dialog" aria-hidden="true">
                                                <div class="modal-dialog" role="document">
                                                   <div class="modal-content" id="modal-content-{{forloop.counter}}">
                                                      <div class="modal-header" style="background-color: #802400;">
                                                         <h5 class="modal-title" id="modal-title-{{forloop.counter}}" style="color:#ffffff;"> Enter password</h5>
                                                         <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                         <span aria-hidden="true">&times;</span>
                                                         </button>
                                                      </div>   
                                                      <div class="modal-body"  style="font-size:12px;">
                                                         <input type="password" required id="ps-verify-{{patient.username}}">
                                                         <span id='p_password_message_{{patient.username}}'></span>

                                                         <!--hide content to be downloaded for modal simplicity -->
                                                         <div hidden id="medhist-download-content-{{patient.username}}" style="border: 1px solid lightgrey;margin-top: 1rem;">
                                                            {% for medhist in patient.medical_history.all %}
                                                               <h3  id="{{forloop.counter}}"><b>{{forloop.counter}}. Medical History</b></h3>
                                                               <p style= "padding-left:10px;padding-top:10px;"><b>Date Edited: </b> {{medhist.created_on}} </p>
                                                               <p style= "padding-left:10px;padding-top:10px;"><b>Name:</b> {{patient.first_name}} {{patient.last_name}} </p>
                                                               <p style= "padding-left:10px;padding-top:10px;"><b>Address:</b> {{patient.present_address}} </p>
                                                               <p style= "padding-left:10px;padding-top:10px;"><b>Result/ Exposure:</b> {{medhist.exposure}} </p>
                                                               <p style= "padding-left:10px;padding-top:10px;"><b>HIV Status:</b> {{patient.HIV_status}}</p>                                                   
                                                               <p style="padding-left:10px;"><b>Other Medical Condition:</b> {{medhist.other_conditions}} </p>
                                                               <p style= "padding-left:10px;"><b>Date Diagnosed/Sample Sent for Confirmatory:</b> {{medhist.date_diagnosed}}</p>
                                                               <br>
                                                               <p>-----------------------------------------------------------------------------</p>
                                                               
                                                            {% endfor %}
                                                            <br>
                                                            <p style= "padding-left:10px;padding-top:10px;">>>>>>>>>>>>>> Nothing Follows >>>>>>>>>>>>>>>>></p>
                                                         </div>
                                                      </div>
                                                      <div id="editor"></div>
                                                      <div class="modal-footer">
                                                         <button disabled  class="btn btn-primary"  data-dismiss="modal" id="download_btn_{{patient.username}}" >Continue Download</button> <!--onclick="downloadMedHist();"-->
                                                      </div>
                                                   </div>
                                                </div>
                                             </div>
                                       </div>

                                       <script>
                                          // input password before downloading medhist
                                          $('#ps-verify-{{patient.username}}').on('keyup', function () {
                                             if ($('#ps-verify-{{patient.username}}').val() != ''){
                                                if ($('#ps-verify-{{patient.username}}').val() == "{{doctor.password}}" ) {
                                                   $('#p_password_message_{{patient.username}}').html('Correct Password').css('color', 'green');
                                                      $("#download_btn_{{patient.username}}").removeAttr('disabled');
                                                }else{
                                                   $('#p_password_message_{{patient.username}}').html('Incorrect Password').css('color', 'red');
                                                   $("#download_btn_{{patient.username}}").attr("disabled", true);
                                                }
                                             }
                                          });

                                          // download medhist
                                          var doc = new jsPDF();
                                          var specialElementHandlers = {
                                             '#editor': function (element, renderer) {
                                                return true;
                                             }
                                          };

                                          $('#download_btn_{{patient.username}}').click(function () {
                                             doc.fromHTML($('#medhist-download-content-{{patient.username}}').html(), 15, 15, {
                                                'width': 170,
                                                      'elementHandlers': specialElementHandlers
                                             });
                                            
                                             //footer
                                             var pageSize = doc.internal.pageSize;
                                             var pageHeight = pageSize.height ? pageSize.height : pageSize.getHeight();
                                             var date_now = new Date();
                                             if (typeof doc.putTotalPages === 'function') { // Total page number plugin only available in jspdf v1.0+
                                                str = "{{patient.username}} Medical History as of: "  + date_now.toDateString();
                                             }
                                             doc.setFontSize(10);
                                             doc.text(str, 10, pageHeight - 5);
                                             doc.save('medhist-{{patient.username}}.pdf');
                                          });

                                          // add remark and edit med hist
                                          $('#button2_{{patient.username}}').click(function(e){
                                             e.preventDefault();
                                             console.log("edit Medhist!");
                                             
                                             $.ajax({
                                                type: "POST",
                                                async: true,
                                                url: '{% url "docMedhist" %}',
                                                data:{
                                                   csrfmiddlewaretoken: '{{ csrf_token }}',
                                                   hiv_level: $('#hiv-level-{{patient.username}}').val(),
                                                   hiv_level_choice: $('#hiv-choice-{{patient.username}}').val(),
                                                   uname: $('#patient-uname-{{patient.username}}').text(),
                                                   exposure: $('#exposure-{{patient.first_name}}').val(),
                                                   other_med_con: $('#other-med-con-{{patient.first_name}}').val(),
                                                   date_diagnosed: $('#date-diagnosed-choices-{{patient.first_name}}').val(),
                                                   remark: $('#medhist-add-doc-remarks-{{forloop.counter}}').val()
                                                   
                                                },
                                                success:function(){
                                                   console.log("edit medhist done!");
                                                   alert("Medhist Form successfully edited. Please refresh to view changes.");
                                                   var remark = $('#medhist-add-doc-remarks-{{forloop.counter}}');
                                                   $("#hiv-level-{{patient.username}}").val($('#hiv-choice-{{patient.username}}').val());
                                                   $("#date-diagnosed-{{patient.first_name}}").val($('#date-diagnosed-choices-{{patient.first_name}}').val());

                                                   if (remark.val().length > 0){
                                                      $('#medhist-remarks').prepend(
                                                         '<hr style="margin:0rem 0rem;">'+ 
                                                         '<div  style="margin-left:1rem; margin-bottom:0rem;">' +
                                                            '<i style="font-size:12px" class="fas">'+ '&#xf070;' + '</i>' + 
                                                            '<b>' + GetUserInforSessionStorage('doc-name-local') + ':' + '</b>' + remark.val() + 
                                                         '</div>'
                                                      );
                                                   }
                                                   remark.val("");
                                                },
                                             });
         
                                          });
                                       
                                          // hide or show buttons for medhist
                                          $("#button1_{{patient.username}}").click(function(){
                                                $('.med-hist-field').removeAttr('readonly'); 
                                                $('#button1_{{patient.username}}').hide();
                                                $('#button2_{{patient.username}}').show();
                                                $('#date-diagnosed-choices-{{patient.first_name}}').show();
                                                $('#date-diagnosed-{{patient.first_name}}').hide();
                                                $('#hiv-choice-{{patient.username}}').show();
                                                $('#hiv-level-{{patient.username}}').hide();
                                                $('#back_btn_{{patient.username}}').show();
                                                $('#download-med-hist-{{patient.username}}').hide();
                                          });
      
                                          $("#button2_{{patient.username}}").click(function(){
                                                $('.med-hist-field').attr('readonly', 'readonly'); 
                                                $('#button2_{{patient.username}}').hide();
                                                $('#button1_{{patient.username}}').show();
                                                $('#date-diagnosed-choices-{{patient.first_name}}').hide();
                                                $('#date-diagnosed-{{patient.first_name}}').show();
                                                $('#hiv-choice-{{patient.username}}').hide();
                                                $('#hiv-level-{{patient.username}}').show();
                                                $('#back_btn_{{patient.username}}').hide();
                                                $('#download-med-hist-{{patient.username}}').show();                                               
                                          });

                                          $('#back_btn_{{patient.username}}').click(function(){
                                             $('.med-hist-field').attr('readonly', 'readonly'); 
                                                $('#button2_{{patient.username}}').hide();
                                                $('#button1_{{patient.username}}').show();
                                                $('#date-diagnosed-choices-{{patient.first_name}}').hide();
                                                $('#date-diagnosed-{{patient.first_name}}').show();
                                                $('#hiv-choice-{{patient.username}}').hide();
                                                $('#hiv-level-{{patient.username}}').show();
                                                $('#back_btn_{{patient.username}}').hide();
                                                $('#download-med-hist-{{patient.username}}').show();
                                          });

                                       </script>

                                       <!-- ICR TAB -->
                                       <div class="patient-tab-content" id="icr-form-content-{{patient.first_name}}">
                                          <form id="icr-form-{{patient.pk}}"   method="post">
                                             {% csrf_token %}
                                             <div class="form-group" id="icr-form-wrapper" style="font-size:small;">
                                                <input hidden name="patient-username" id="icr-patient-uname-{{patient.username}}" value="{{patient.username}}">                                                                                   
                                                <div class="row" style="padding-top:10px;">
                                                   <div class="col-md-6">
                                                      <div class="form-group">
                                                         <p>
                                                         <label for="icr-s-name" class="text-black">Surname: </label>
                                                         <input class="icr-field" id="icr-s-name-{{patient.username}}" name="icr-s-name" readonly required value="{{patient.icr.last_name}}">
                                                         </p>
                                                      </div>
                                                   </div> 
                                                </div>
                                                <div class="row" >
                                                   <div class="col-md-6">
                                                      <div class="form-group">
                                                         <p>
                                                         <label for="icr-f-name" class="text-black">First Name: </label>
                                                         <input class="icr-field" id="icr-f-name-{{patient.username}}" name="icr-f-name"  readonly required value="{{patient.icr.first_name}}">
                                                      </p>
                                                      </div>
                                                   </div> 
                                                </div>
                                                <div class="row" >
                                                   <div class="col-md-6">
                                                      <div class="form-group">
                                                         <p>
                                                         <label for="icr-m-initial" class="text-black">Middle Initial: </label>
                                                         <input class="icr-field" id="icr-m-name-{{patient.username}}" name="icr-m-name"  readonly required value="{{patient.icr.middle_name}}">
                                                         </p>
                                                      </div>
                                                   </div> 
                                                </div>
                                                <div class="row" >
                                                   <div class="col-md-6">
                                                      <div class="form-group">
                                                         <p>
                                                         <label for="icr-v-date" class="text-black">Date of Visit: </label>
                                                         <input type="date" class="icr-field" id="icr-v-date-{{patient.username}}" name="icr-v-date"  readonly required value="{{patient.icr.date_of_visit}}">
                                                         </p>
                                                      </div>
                                                   </div> 
                                                </div>
                                                <div class="row" >
                                                   <div class="col-md-6">
                                                      <div class="form-group">
                                                         <p>
                                                         <label for="icr-age" class="text-black">Age: </label>
                                                         <input class="icr-field" type="number" min="1" max="200" id="icr-age-{{patient.username}}" name="icr-age"  readonly required value="{{patient.icr.age}}">
                                                         </p>
                                                      </div>
                                                   </div> 
                                                </div>
                                                <div class="row" >
                                                   <div class="col-md-6">
                                                      <div class="form-group">
                                                         <p>
                                                            <label for="icr-b-date" class="text-black">Birth Date: </label>
                                                            <input class="icr-field" type="date" id="icr-b-date-{{patient.username}}" name="icr-b-date"  readonly required value="{{patient.icr.birthdate}}">
                                                         </p>
                                                         
                                                      </div>
                                                   </div> 
                                                </div>
                                                <div class="row" >
                                                   <div class="col-md-6">
                                                      <div class="form-group">
                                                        <p>
                                                         <label for="icr-sex" class="text-black">Sex: </label>
                                                         <select class="icr-field" id="icr-sex-{{patient.username}}" name="icr-sex"  readonly required value="{{patient.icr.sex}}" >
                                                            <option value="female">Female</option>
                                                            <option value="male">Male</option>
                                                         </select>
                                                      </p>
                                                      </div>
                                                   </div> 
                                                </div>
                                                <div class="row" >
                                                   <div class="col-md-6">
                                                      <div class="form-group">
                                                         <p>
                                                         <label for="icr-c-status" class="text-black">Civil Status: </label>
                                                         <select class="icr-field" id="icr-c-status-{{patient.username}}" name="icr-c-status"  readonly required value="{{patient.icr.civil_status}}">
                                                            <option value="single">Single</option>
                                                            <option value="married"> Married</option>
                                                            <option value="divorced">Divorced</option>
                                                         </select>
                                                      </p>
                                                      </div>
                                                   </div> 
                                                </div>
                                                <div class="row" >
                                                   <div class="col-md-6">
                                                      <div class="form-group">
                                                         <p>
                                                         <label for="icr-p-num" class="text-black">Phone Number: </label>
                                                         <input class="icr-field" type="tel" pattern="09[1-9]{9}" id="icr-p-num-{{patient.username}}" name="icr-p-num"  readonly required value="{{patient.icr.phone_number}}">
                                                         </p>
                                                      </div>
                                                   </div> 
                                                </div>
                                                <div class="row" >
                                                   <div class="col-md-6">
                                                      <div class="form-group">
                                                         <p>
                                                         <label for="icr-h-num" class="text-black">Home Address: </label>
                                                         <input class="icr-field" id="icr-h-num-{{patient.username}}" name="icr-h-add" readonly required value="{{patient.icr.home_address}}">
                                                      </p>
                                                      </div>
                                                   </div> 
                                                </div>
                                                <div class="row" >
                                                   <div class="col-md-6">
                                                      <div class="form-group">
                                                      <p>
                                                         <label for="icr-occ" class="text-black">Occupation: </label>
                                                         <input class="icr-field" id="icr-occ-{{patient.username}}" name="icr-occ"  readonly required value="{{patient.icr.occupation}}">
                                                      </p>
                                                      </div>
                                                   </div> 
                                                </div>
                                                <div class="row" >
                                                   <div class="col-md-6">
                                                      <div class="form-group">
                                                         <p>
                                                            <label for="work-add" class="text-black">Work Address: </label>
                                                            <input class="icr-field" id="icr-work-add-{{patient.username}}" name="icr-work-add"  readonly required value="{{patient.icr.work_address}}">
                                                         </p>
                                                      </div>
                                                   </div> 
                                                </div>
                                                <div class="row" >
                                                   <div class="col-md-6">
                                                      <div class="form-group">
                                                         <p>
                                                         <label for="icr-work-num" class="text-black">Work Telephone or Cellphone Number: </label>
                                                         <input class="icr-field" type="tel" pattern="09[1-9]{9} | [1-9]{7}" id="icr-work-num-{{patient.username}}" name="icr-work-num"  readonly required value="{{patient.icr.work_number}}">
                                                         </p>
                                                      </div>
                                                   </div> 
                                                </div>
                                                <div class="row" >
                                                   <div class="col-md-6">
                                                      <div class="form-group">
                                                         <p>
                                                            <label for="icr-p-visit" class="text-black">Purpose of Visit: </label>
                                                            <select class="icr-field" id="icr-p-visit-{{patient.username}}" name="icr-p-visit"  readonly required value="{{patient.icr.purpose_of_visit}}">
                                                               <option value="routine-checkup">Routine Checkup</option>
                                                               <option value="sti-s/sx">STI S/Sx</option>
                                                               <option value="hiv-testing">HIV Testing</option>
                                                               <option value="contact-of-hiv-sti-case">Contact of STI/HIV case</option>
                                                               <option value="referred">Referred from other facility</option>
                                                               <option value="others"> Others: <input hidden type="text" id="other-choices-{{patient.username}}"></option>
                                                            </select>
                                                         </p>
                                                      </div>
                                                   </div> 
                                                </div>
                                                <div class="row" >
                                                   <div class="col-md-6">
                                                      <div class="form-group">
                                                         <p>
                                                            <label for="icr-symptoms" class="text-black">Symptoms: </label>
                                                            <input class="icr-field" id="icr-symptoms-{{patient.username}}" name="icr-symptoms"  readonly value="{{patient.icr.symptoms}}">
                                                          </p>
                                                      </div>
                                                   </div> 
                                                </div>
                                                
						<div class="row" >
                                                   <div class="col-md-6">
                                                      <div class="form-group">
                                                         <p>
                                                            <label for="icr-specs"  class="text-black">Specification: </label>
                                                            <input class="icr-field" id="icr-specs-{{patient.username}}" name="icr-specs" readonly value="{{patient.icr.specification}}">
                                                         </p>
                                                      </div>
                                                   </div> 
                                                </div>

                                                <!-- add a remark -->
                                                <p style= "margin-bottom:0px; font-size: 12px; color:grey;">seen by: 
                                                   {% for viewer in patient.icr.docs_viewed.all %}
                                                      {{viewer.viewer_name}} |
                                                   {% empty %}
                                                   ...
                                                   {% endfor %}
                                                </p>

                                                <hr style="border-top: 2px solid rgba(0, 0, 0, 0.1); margin-bottom:0px;">  
                                                <p class="doc-remarks-header"><b>Doctor(s) Remarks: </b></p>
                                                <hr style="margin:0rem 0rem;">
                                                <p style="margin-bottom: 0rem;"><b>Add a remark:</b> </p>
                                                <textarea class="icr-field" readonly style="margin-left:1rem;margin-top:0.5rem;"cols="50" rows="2" id="icr-add-doc-remarks-{{patient.username}}" name="icr-add-doc-remarks"></textarea>                                                      
                                                
                                                {% for remark in patient.icr.doctor_remarks.all %}
                                                   <hr style="margin:0rem 0rem;">
                                                   <div id="icr-remarks" style="margin-left:1rem; margin-bottom:0rem;">
                                                      {% if remark.remark_seen == True %}
                                                      <i style='font-size:12px' class='fas'>&#xf06e;</i>
                                                      {% else %}
                                                      <i style='font-size:12px' class='fas'>&#xf070;</i>
                                                      {% endif %}
                                                      <b>Dr.{{remark.author}}:</b>{{remark.text}}
                                                   </div>
                                                {% empty %}
                                                   <hr style="margin:0rem 0rem;">
                                                   <p>No remarks yet..</p>
                                                {% endfor%}
                                                
                                                <hr style="margin:0rem 0rem;">
                                                <div class="form-group" style="margin:1rem;">  
                                                   <button style="font-size:12px;" class="btn btn-primary" id="download-icr-{{patient.username}}" type="button" data-toggle="modal" data-target="#ps-ver-icr-{{patient.username}}"><i class="fa fa-download"> </i>Download</button>           
                                                   <button style="font-size:12px;" class="btn btn-primary" id="edit_icr_{{patient.username}}" type="button">Edit</button>
                                                   <button style="font-size:12px; display:none;" type="submit" class="btn btn-primary" id="save_icr_{{patient.username}}" >Save</button>
                                                </div>
                                             </div>
                                          </form>  

                                           <!-- modal to input password before download -->
                                          <div class="modal fade" id="ps-ver-icr-{{patient.username}}" tabindex="-1" role="dialog" aria-hidden="true">
                                             <div class="modal-dialog" role="document">
                                                <div class="modal-content" id="modal-content-{{forloop.counter}}">
                                                   <div class="modal-header" style="background-color: #802400;">
                                                      <h5 class="modal-title" id="modal-title-{{forloop.counter}}" style="color:#ffffff;"> Enter password</h5>
                                                      <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                      <span aria-hidden="true">&times;</span>
                                                      </button>
                                                   </div>
                                                   <div class="modal-body"  style="font-size:12px;">
                                                      <input type="password" id="icr_ps_verify_{{patient.username}}">
                                                      <span id='icr_password_message_{{patient.username}}'></span>
                                                      <!-- content to download hidden for simplicity -->
                                                      <div hidden id="icr-download-content-{{patient.username}}">
                                                         <h5><b>Individual Client Record for Referrals/Walk-in Clients</b></h5>
                                                         <p><b>Last name: </b>{{patient.icr.last_name}}</p>
                                                         <p><b>First Name: </b>{{patient.icr.first_name}}</p>
                                                         <p><b>Middle Initial: </b>{{patient.icr.middle_name}}</p>
                                                         <p><b>Date of Visit: </b>{{patient.icr.date_of_visit}}</p>
                                                         <p><b>Age: </b>{{patient.icr.age}}</p>
                                                         <p><b>Birth Date: </b>{{patient.icr.birthdate}}</p>
                                                         <p><b>Sex: </b>{{patient.icr.sex}}</p>
                                                         <p><b>Civil Status: </b>{{patient.icr.civil_status}}</p>
                                                         <p><b>Phone Number: </b>{{patient.icr.phone_number}}</p>
                                                         <p><b>Home Address: </b>{{patient.icr.home_address}}</p>
                                                         <p><b>Occupation: </b>{{patient.icr.occupation}}</p>
                                                         <p><b>Work Address: </b>{{patient.icr.work_address}}</p>
                                                         <p><b>Work Telephone or Cellphone Number: </b>{{patient.icr.work_number}}</p>
                                                         <p><b>Purpose of Visit: </b>{{patient.icr.purpose_of_visit}}</p>
                                                         <p><b>Symptoms: </b>{{patient.icr.symptoms}}</p>
                                                         <p><b>Specifications:  </b>{{patient.icr.specification}}</p>

                                                         <br>
                                                         <p>>>>>>>>>>>>>>Nothing Follows>>>>>>>>>>>>>>>>></p>
                                                      </div>
                                                   </div>
                                                   <div class="modal-footer">
                                                      <button disabled  class="btn btn-primary" data-dismiss="modal" id="download_icr_btn_{{patient.username}}" onclick="downloadICR()" >Continue Download</button>
                                                   </div>
                                                </div>
                                             </div>
                                          </div>
                                       </div>

                                       <script>
                                          // download ICR Form
                                          $('#icr_ps_verify_{{patient.username}}').on('keyup', function () {
                                             if ($('#icr_ps_verify_{{patient.username}}').val() != ''){
                                                if ($('#icr_ps_verify_{{patient.username}}').val() == "{{doctor.password}}" ) {
                                                   $('#icr_password_message_{{patient.username}}').html('Correct Password').css('color', 'green');
                                                      $("#download_icr_btn_{{patient.username}}").removeAttr('disabled');
                                                }else{
                                                   $('#icr_password_message_{{patient.username}}').html('Incorrect Password').css('color', 'red');
                                                   $("#download_icr_btn_{{patient.username}}").attr("disabled", true);
                                                }
                                             }

                                          });   

                                          var base64Img = null;
                                          margins = {
                                          top: 70,
                                          bottom: 40,
                                          left: 30,
                                          width: 550
                                          };
                                          function downloadICR(){ // function to download the icr-form
                                             console.log("download icr clicked!");

                                             var pdf = new jsPDF('p', 'pt', 'a4');
                                             pdf.setFontSize(25);
                                             pdf.fromHTML(document.getElementById('icr-download-content-{{patient.username}}'), 
                                                margins.left, // x coordinates
                                                margins.top,
                                                {
                                                   width: margins.width// y coordinates, max width for PDF
                                                },function(dispose) {
                                                   headerFooterFormatting(pdf)
                                                }, 
                                                margins);

                                             //footer
                                             var pageSize = pdf.internal.pageSize;
                                             var pageHeight = pageSize.height ? pageSize.height : pageSize.getHeight();
                                             var date_now = new Date();
                                             if (typeof pdf.putTotalPages === 'function') { // Total page number plugin only available in jspdf v1.0+
                                                str = "{{patient.username}} ICR Form as of: "  + date_now.toDateString();
                                             }
                                             pdf.setFontSize(10);
                                             pdf.text(str, 10, pageHeight - 7);
                                                
                                             pdf.save("ICRForm-{{patient.username}}.pdf");

                                          }

                                          function header(doc){
                                             doc.setFontSize(30);
                                             doc.setTextColor(40);
                                             doc.setFontStyle('normal');                                          
                                             doc.text("", margins.left + 50, 40 );
                                          
                                             doc.line(3, 70, margins.width + 43,70); 
                                          };

                                          function headerFooterFormatting(doc){
                                             var totalPages  = doc.internal.getNumberOfPages();
                                             for(var i = totalPages; i >= 1; i--){ 
                                                //make this page, the current page we are currently working on.
                                                doc.setPage(i);      
                                                header(doc); 
                                             }
                                          };

                                          // hide or show buttons in ICR Form
                                          $('#edit_icr_{{patient.username}}').click(function(){
                                             console.log("edit clickeddd");
                                             $('.icr-field').removeAttr('readonly'); 
                                                $('#save_icr_{{patient.username}}').show();
                                                $("#edit_icr_{{patient.username}}").hide();   
                                                $('#download-icr-{{patient.username}}').hide();
                                          });

                                          $("#save_icr_{{patient.username}}").click(function(e){
                                             console.log("save clicked!!!");
                                             $('.icr-field').attr('readonly', 'readonly'); 
                                             $("#edit_icr_{{patient.username}}").show();
                                             $('#save_icr_{{patient.username}}').hide();
                                             $('#download-icr-{{patient.username}}').show();
                                            
                                          }); 


                                          // add remark or edit ICR Form
                                          $(document).on('submit','#icr-form-{{patient.pk}}', function(e){
                                             console.log("edit ICR!");
                                             e.preventDefault();
                                             
                                             console.log("ICR SURNAME: ", $('#icr-patient-uname-{{patient.username}}').val());
                                             
                                             $.ajax({
                                                type: "POST",
                                                async: true,
                                                url: '{% url "docEditICR" %}',
                                                data:{
                                                   csrfmiddlewaretoken: '{{ csrf_token }}',
                                                   patient_icr_uname: $('#icr-patient-uname-{{patient.username}}').val(),
                                                   remark : $('#icr-add-doc-remarks-{{patient.username}}').val(),
                                                   first_name: $('#icr-f-name-{{patient.username}}').val(),
                                                   surname: $('#icr-s-name-{{patient.username}}').val(),
                                                   middle_name: $('#icr-m-name-{{patient.username}}').val(),
                                                   visit_date: $('#icr-v-date-{{patient.username}}').val(),
                                                   age: $('#icr-age-{{patient.username}}').val(),
                                                   bdate: $('#icr-b-date-{{patient.username}}').val(),
                                                   sex: $('#icr-sex-{{patient.username}}').val(),
                                                   civil_status: $('#icr-c-status-{{patient.username}}').val(),
                                                   phone_num: $('#icr-p-num-{{patient.username}}').val(),
                                                   home_add: $('#icr-h-num-{{patient.username}}').val(),
                                                   occupation: $('#icr-occ-{{patient.username}}').val(),
                                                   work_add: $('#icr-work-add-{{patient.username}}').val(),
                                                   work_num: $('#icr-work-num-{{patient.username}}').val(),
                                                   visit_purpose: $('#icr-p-visit-{{patient.username}}').val(),
                                                   symptoms:$('#icr-symptoms-{{patient.username}}').val(),
                                                   specs: $('#icr-specs-{{patient.username}}').val()
                                                   
                                                },
                                                success:function(){
                                                   console.log("edit ICR done!");
                                                   alert("Edit ICR done. Please refresh to view changes.");
                                                   var remark = $('#icr-add-doc-remarks-{{patient.username}}');
                                                   if (remark.val().length > 0){
                                                      $('#icr-remarks').prepend(
                                                         '<i style="font-size:12px" class="fas">'+ '&#xf070;' + '</i>' + 
                                                         '<b>' + GetUserInforSessionStorage('doc-name-local') + ':' + '</b>' + remark.val() + 
                                                         '<hr style="margin:0rem 0rem;">'
                                                      );
                                                   }
                                                   remark.val(""); 
                                                },
                                             });         
                                          });
                                       </script>          
                                       <!-- END OF ICR EDIT AND DOWNLOAD -->

                                       <!-- TAB ART MEDICATIONS OF PATIENT -->
                                       <div class="patient-tab-content" id="p-art-content-{{patient.first_name}}" style="border-top:0px;">
                                          <div class="table-responsive">
                                             <table class="table table-hover" style="font-family:Roboto, Arial, sans-serif;">
                                                <thead class=" text-primary">
                                                   <th>
                                                      Drug Name
                                                   </th>
                                                   <th>
                                                      Unit of Measure (UOM)
                                                   </th>
                                                   <th>
                                                      Content per bottle
                                                   </th>
                                                   <th >
                                                      Administered    ` 
                                                   </th>
                                                   <th class="text-right">
                                                      Administered By
                                                   </th>
                                                </thead>
                                                <tbody>
                                                   {% for med in patient.meds.all %}
                                                      <tr  style="border-bottom: 1px solid lightgrey;">
                                                         <td>
                                                            {{med.drug_name}}
                                                         </td>
                                                         <td>
                                                            {{med.unit_of_measure}}
                                                         </td>
                                                         <td>
                                                            {{med.content_per_bottle}}
                                                         </td>
                                                         <td>
                                                            {{med.administered}}
                                                         </td>
                                                         <td class="text-right">
                                                            {{med.administered_by}}
                                                         </td>
                                                      </tr>
                                                   {% empty %}
                                                   <tr><td>None...</td></tr>
                                                   {% endfor %}
                                                </tbody>
                                             </table>
                                          </div>
                                          <input id="add-med-{{patient.username}}" type="button" style="margin-left:1rem;" data-toggle="modal" data-target="#add-medication-{{patient.username}}" value="add a medication" >
                                          
                                          <!-- modal for adding patient medication -->
                                          <div class="modal fade" id="add-medication-{{patient.username}}" tabindex="-1" role="dialog" aria-hidden="true">
                                             <div class="modal-dialog" id="modal-dialog-{{forloop.counter}}" role="document" style="max-width: 50%;">
                                                <div class="modal-content" id="add-med-content-{{patient.username}}">
                                                   <div class="modal-header"  style="background-color: #802400;">
                                                      <h5 class="modal-title" id="modal-title-{{schedule.patient_username}}" style="color:#ffffff;"> Add a Medication</h5>
                                                      <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                         <span aria-hidden="true" style="color:#ffffff;">&times;</span>
                                                      </button>
                                                   </div>
                                                   <div class="modal-body" id="body-{{forloop.counter}}" style="max-height:calc(100vh - 210px); overflow-y: auto;">
                                                      <table class="table table-hover" id="table-{{forloop.counter}}" style="font-family:Roboto, Arial, sans-serif;">
                                                         <thead class=" text-primary">
                                                            <th >
                                                               Availability 
                                                            </th>
                                                            <th>
                                                               Drug Name
                                                            </th>
                                                            <th>
                                                               Unit of Measure (UOM)
                                                            </th>
                                                            <th>
                                                               Content per bottle
                                                            </th>
                                                            <th class="text-right">
                                                               Stocks on Hand
                                                            </th>
                                                         </thead>
                                                         <tbody>
                                                            {% for med in medicines %}
                                                               <tr id="med-{{forloop.counter}}" style="border-bottom: 1px solid lightgrey;">
                                                                  <td>
                                                                     <input class="stretched-link med-for-{{patient.username}}" type="checkbox" value="{{med.pk}}">
                                                                     {{med.availability}}
                                                                  </td>
                                                                  <td>
                                                                     {{med.drug_name}}
                                                                  </td>
                                                                  <td>
                                                                     {{med.unit_of_measure}}
                                                                  </td>
                                                                  <td >
                                                                     {{med.content_per_bottle}}
                                                                  </td>
                                                                  <td class="text-right">
                                                                     {{med.stocks_on_hand}}
                                                                  </td>
                                                               </tr>
                                                            {% empty %}
                                                            <tr><td>None...</td></tr>
                                                            {% endfor %}
                                                         </tbody>
                                                      </table>
                                                   </div>
                                                   <div class="modal-footer">
                                                      <button id="add-mednotes-btn-{{patient.username}}">add a note for the patient?</button>
                                                      <div style="text-align:left;">
                                                         <div>
                                                            <label for="meds-note-{{patient.username}}" id="meds-note-lable-{{patient.username}}" style="display:none; margin:auto;">Add a doctor's note: </label>
                                                            <textarea id="meds-note-{{patient.username}}" style="display:none; margin-left:1rem;margin-top:0.5rem;" cols="50" rows="4" id="meds-note-{{patient.username}}" name="meds-note" placeholder="notes for the patient on the medicine added..."></textarea>
                                                         </div>
                                                         <div>
                                                            <button id="back-mednotes-btn-{{patient.username}}" style="display:none; margin-left: 20rem;">Back</button>
                                                            <button id="add-med-btn-{{patient.username}}" data-dismiss="modal" >Add Medication</button>
                                                            <button data-dismiss="modal"><i style="font-size:18px" class="fa">&#xf105;</i> </button>
                                                         </div>
                                                      </div>
                                                   </div>
                                                </div>
                                             </div>
                                          </div>
                                       </div>

                                       <script>

                                          $('#add-mednotes-btn-{{patient.username}}').click(function(){
                                             $('#back-mednotes-btn-{{patient.username}}').show();
                                             $('#meds-note-lable-{{patient.username}}').css("display", "block");
                                             $('#meds-note-{{patient.username}}').show();
                                             $('#add-mednotes-btn-{{patient.username}}').hide();

                                          });

                                          $('#back-mednotes-btn-{{patient.username}}').click(function(){
                                             $('#back-mednotes-btn-{{patient.username}}').hide();
                                             $('#meds-note-lable-{{patient.username}}').hide();
                                             $('#meds-note-{{patient.username}}').hide();
                                             $('#add-mednotes-btn-{{patient.username}}').show();
                                          });

                                          var addMedsList = []; //empty list for downloading data per brgy
                                          
                                          $('.med-for-{{patient.username}}').on('change', function() {
                                                if ($(this).prop('checked') == false){
                                                   addMedsList.pop($(this).val());
                                                }
                                                else{
                                                   addMedsList.push($(this).val());
                                                }
                                                console.log("list: ", addMedsList);
                                          });
                                         
                                         $('#add-med-btn-{{patient.username}}').click(function(e){
                                             console.log("add MEDICATIONS clicked!!");
                                             e.preventDefault();

                                            console.log("{{patient.username}}");

                                             $.ajax({
                                                type:"POST",
                                                async:true,
                                                url:'/addMeds/',
                                                data:{
                                                   csrfmiddlewaretoken: '{{ csrf_token }}',
                                                   new_meds: addMedsList,
                                                   notes: $('#meds-note-{{patient.username}}').val(),
                                                   curr_patient: '{{patient.username}}'
                                                },
                                                success:function(){
                                                   console.log("Done adding medication.");
                                                   alert("Done adding medication. Please refresh to view changes.");
                                                }
                                             });                                             
                                         });
                                      </script>

                                       <!-- PERSONAL RECORDS -->
                                       <div class="patient-tab-content" id="p-record-content-{{patient.first_name}}" style="border-top:0px;">
                                          {% for post in patient.personal_records.all %}
                                             <div id="{{post.pk}}-p-records">
                                                <div class="post-title" id="rec-title-{{post.pk}}">
                                                   <div class="view-record" id="div-view-record-{{post.pk}}">
                                                      <form id="seenflag-{{post.pk}}" onsubmit="return false;">
                                                         {% csrf_token %}
                                                         <input hidden  id="viewed-type-{{post.pk}}" name="viewed_type" value="Personal Record">
                                                         <input hidden  id="record-pk-{{post.pk}}" name="file_pk" type="number" value="{{post.pk}}">
                                                         <input hidden  id="record-owner-{{post.pk}}" name="file_owner"  value="{{patient.username}}">
                                                         <p class="p-record-par" id="view-record-{{post.pk}}" style="padding-top:0.5rem;" >{{ post.title }}</p>
                                                      </form>
                                                   </div>
                                                   <div class="unview-record" id="div-unview-record-{{post.pk}}">
                                                      <p class="p-record-par" id="unview-record-{{post.pk}}" style="padding-top:0.5rem; font-weight:600; display:none;">{{ post.title }}</p>
                                                   </div>
                                                   <hr style="margin-bottom:0px; border-top: 2px solid rgba(139, 33, 33, 0.1)">
                                                </div>                                                

                                                <div id="record-content-{{post.pk}}" style="display:none; border-radius:10px; border:2px solid rgba(128, 29, 29, 0.781);">
                                                   <p class="p-record-par" id="date-created-{{post.pk}}"><u>| {{ post.created_on}} </u></p>
                                                   <p class="p-record-par" id="content-preview-{{post.pk}}">{{post.content|slice:":100" }}...</p>
                                                   <p class="p-record-par" id="content-full-{{post.pk}}" style="display:none;">{{post.content}}</p>
                                                   <p class="p-record-par" id="read-more-{{post.pk}}"><b>Read more...</b></p>
                                                   <p class="p-record-par" id="read-less-{{post.pk}}" style="display:none;"><b>Read less</b></p>
                                                   <p  id="record-viewers" style= "margin-bottom:0px; font-size: 12px; color:grey;">seen by: 
                                                      {% for viewer in post.docs_viewed.all %}
                                                         {{viewer.viewer_name}} |
                                                      {% empty %}
                                                      ...
                                                      {% endfor %}
                                                   </p>

                                                   <hr style="border-top: 2px solid rgba(0, 0, 0, 0.1)">

                                                   <div id="comments-section" style="border:none;">
                                                      <p class="p-record-par" style="margin-left:0rem;"><font size="2"><b>Doctor(s) comments:</b> {{ post.comment.count }}</font></p>
                                                      <hr style="margin-top:0.5rem; margin-bottom:0rem; border-top: 2px solid rgba(100, 58, 58, 0.1);">
                                                      <div id="add-comment-section" name="add-comment-section">
                                                         <div name="comments"  style="margin-bottom:1rem;;">
                                                            {% for comment in post.comment.all %}
                                                               <p class="p-record-par" style="margin-bottom:0rem; margin-left:0rem;" id="doc-comment-{{comment.author}}" name="doc-comment"><b>{{comment.author}}</b>: {{comment.text}}</p>
                                                               <hr style="margin-bottom:0rem; margin-top:0rem;">
                                                            {% endfor%}
                                                         </div>
                                                         
                                                         <form method="post">
                                                            {% csrf_token %}
                                                            <p class="p-record-par"  style="margin-left:0rem;"> <b>Dr. {{doctor.name}}: </b>
                                                               <input  class="patient-content" style="margin-left:0rem;margin-right:0rem;" id="new-comment-{{post.pk}}" name="new-comment" placeholder="add a comment..." style="margin-right:0rem;">
                                                               <button class="patient-content" style="margin-left:0rem;" id="add-comment-btn-{{post.pk}}" name="add-comment-btn" style="margin-left:0rem;">add</button>
                                                            </p>
                                                         </form>   

                                                         <script>
                                                            // add a comment on patient personal journal
                                                            $('#add-comment-btn-{{post.pk}}').click(function(e){
                                                               //alert('{{post.author}}');
                                                               e.preventDefault();
                                                               $.ajax({
                                                                  type:"POST",
                                                                  async:true,
                                                                  url:'{% url "addcomment"%}',
                                                                  data:{
                                                                     csrfmiddlewaretoken: '{{ csrf_token }}', 
                                                                     record_patient_username: '{{post.author}}',
                                                                     record_patient_slug: '{{post.slug}}',
                                                                     new_comment: $('#new-comment-{{post.pk}}').val()
                                                                  },
                                                                  success:function(){
                                                                     console.log("add comment success: ");
                                                                     alert("add comment success. Refresh to view changes.")
                                                                  }
                                                              });
                                                            })
                                                         </script>
                                                      </div>
                                                   </div>
                                                </div>
                                             </div>
                                             <hr style="margin-top:0px;margin-bottom:0px; border:2px solid rgba(100, 58, 58, 0.1); ">
            
                                             <script> 
                                                $('#view-record-{{post.pk}}').click(function() {
                                                   $('#rec-title-{{post.pk}}').addClass('record-active');
                                                });

                                                $('#unview-record-{{post.pk}}').click(function(){
                                                   $('#rec-title-{{post.pk}}').removeClass('record-active');
                                                })

                                                $("#view-record-{{post.pk}}").click(function(){
                                                   $("#record-content-{{post.pk}}").show();
                                                   $("#unview-record-{{post.pk}}").show();
                                                   $("#view-record-{{post.pk}}").hide()
                                                   $("#ellipsis").hide();
                                                });
            
                                                $("#unview-record-{{post.pk}}").click(function(){
                                                   $("#record-content-{{post.pk}}").hide();
                                                   $("#unview-record-{{post.pk}}").hide();
                                                   $("#view-record-{{post.pk}}").show()
                                                   $("#ellipsis").show();
                                                });
            
                                                $("#read-more-{{post.pk}}").click(function(){
                                                   $("#read-more-{{post.pk}}").hide();
                                                   $("#read-less-{{post.pk}}").show();
                                                   $("#content-preview-{{post.pk}}").hide();
                                                   $("#content-full-{{post.pk}}").show();
                                                });
                  
                                                $("#read-less-{{post.pk}}").click(function(){
                                                   $("#read-less-{{post.pk}}").hide();
                                                   $("#read-more-{{post.pk}}").show();
                                                   $("#content-full-{{post.pk}}").hide();
                                                   $("#content-preview-{{post.pk}}").show();
                                                });

                                                $('#view-record-{{post.pk}}').click(function(e){
                                                   e.preventDefault();

                                                   $.ajax({
                                                      type:"POST",
                                                      async:true,
                                                      url:'/addSeen/',
                                                      data:{
                                                         csrfmiddlewaretoken: '{{ csrf_token }}', 
                                                         viewed_type: $('#viewed-type-{{post.pk}}').val(),
                                                         file_pk: $('#record-pk-{{post.pk}}').val(),
                                                         file_owner: $('#record-owner-{{post.pk}}').val()
                                                      },
                                                      success:function(){
                                                         console.log("add record seen success: " + $('#record-owner-{{post.pk}}').val());
                                                      }
                                                   });
                                                });                                               
                                             </script>
            
                                             {% empty%}
                                                <p>no personal records available ... </p>
                                             {% endfor %}
                                       </div>
                                    </div> 
                                 </div>
                              </div>
                              {% empty %}
                                 <p>No patients yet...</p>
                              {% endfor %}
                              <!-- END OF PATIENTS LIST -->
                        </div>
                     </div>
                  </div>
               </div>
            </div>
         </div>
      </div>
   </div>

   <!-- loader -->
   <div id="ftco-loader" class="show fullscreen">
      <svg class="circular" width="48px" height="48px">
         <circle class="path-bg" cx="24" cy="24" r="22" fill="none" stroke-width="4" stroke="#eeeeee"/>
         <circle class="path" cx="24" cy="24" r="22" fill="none" stroke-width="4" stroke-miterlimit="10" stroke="#F96D00"/>
      </svg>
   </div>      

   <script src="{% static 'portal/js/jquery.min.js' %}"></script>
   <script src="{% static 'portal/js/jquery-migrate-3.0.1.min.js' %}"></script>
   <script src="{% static 'portal/js/popper.min.js' %}"></script>
   <script src="{% static 'portal/js/bootstrap.min.js' %}"></script>
   <script src="{% static 'portal/js/jquery.easing.1.3.js' %}"></script>
   <script src="{% static 'portal/js/jquery.waypoints.min.js' %}"></script>
   <script src="{% static 'portal/js/jquery.stellar.min.js' %}"></script>
   <script src="{% static 'portal/js/owl.carousel.min.js' %}"></script>
   <script src="{% static 'portal/js/jquery.magnific-popup.min.js' %}"></script>
   <script src="{% static 'portal/js/aos.js' %}"></script>
   <script src="{% static 'portal/js/jquery.animateNumber.min.js' %}"></script>
   <script src="{% static 'portal/js/bootstrap-datepicker.js' %}"></script>
   <script src="{% static 'portal/js/jquery.timepicker.min.js' %}"></script>
   <script src="{% static 'portal/js/scrollax.min.js' %}"></script>
   <script src="{% static 'portal/js/main.js' %}"></script>   

<script>
   function csrfSafeMethod(method) {
      // these HTTP methods do not require CSRF protection
      return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
   }

   // resize the input based on the length of its value
   function resizeInput() {
      $(this).attr('size', $(this).val().length);
   }

   $('input[type="text"]')
      // event handler
      .keyup(resizeInput)
      // resize on page load
      .each(resizeInput);

   $('#schedules-tab').click(function(){
      $('#pending-scheds').show();
   });

   //for collapsible tabs
   function openDetails(evt, cityName) {
      var i, tabcontent, tablinks;
      tabcontent = document.getElementsByClassName("patient-tab-content");
      for (i = 0; i < tabcontent.length; i++) {
         tabcontent[i].style.display = "none";
      }

      tablinks = document.getElementsByClassName("tablinks");
      for (i = 0; i < tablinks.length; i++) {
         tablinks[i].className = tablinks[i].className.replace(" active", "");
      }

      document.getElementById(cityName).style.display = "block";
      evt.currentTarget.className += " active";
      }


      var coll = document.getElementsByClassName("collapsible");
      var i;

      for (i = 0; i < coll.length; i++) {
      coll[i].addEventListener("click", function() {
         this.classList.toggle("active");
         var content = this.nextElementSibling;
         if (content.style.display === "block") {
            content.style.display = "none";
         } else {
            content.style.display = "block";
         }
      });
     }
     //end

      // REMOVE PATIENTS
      var closebtns = document.getElementsByClassName("close");
      var i;
      for (i = 0; i < closebtns.length; i++) {
	 closebtns[i].addEventListener("click", function() {
       	     this.parentElement.style.display = 'none';
     	 });
      }
      //end
   

      //GET CURRENT USER
      function GetUserInforSessionStorage(key){
         var realName = sessionStorage.getItem(key);        
         return realName;    
      } 

      function SetElementValueFromSessionStorage(elementId, key){
         var val = GetUserInforSessionStorage(key);
         $(document).find('#'+elementId).val(val); 
      }
      // end


      //allow icr fields editable or not
      $("#edit-icr").click(function(){
         $('.icr-field').removeAttr('readonly'); 
         $('#save-icr').show();
         $("#edit-icr").hide();                                                   
      });
      $("#save-icr").click(function(){
         $('.icr-field').attr('readonly', 'readonly'); 
         $("#edit-icr").show();
         $('#save-icr').hide();
      });   
      //end

     
       //allow med-hist fields editable or not
       $("#edit-med-hist").click(function(){
         $('.med-hist-field').removeAttr('readonly'); 
         $('#save-med-hist').show();
         $("#edit-med-hist").hide();                                                   
      });
      $("#save-med-hist").click(function(){
         $('.med-hist-field').attr('readonly', 'readonly'); 
         $("#edit-med-hist").show();
         $('#save-med-hist').hide();
      });   
      //end


      // log out
      $("#log-out").click(function(){
         sessionStorage.clear(); //use this when logging out
      });


      // NOTIFICATION BELL BADGE
      $('#notification').click(function(){
         $('.badge').hide();
      });

 

      // DOCTOR CHANGE PROFILE PICTURE
       //  post a preview of the uploaded image for profile picture
       function PreviewImage() {
         var oFReader = new FileReader();
         oFReader.readAsDataURL(document.getElementById("new-prof-pic").files[0]);
         oFReader.onload = function (oFREvent) {
               document.getElementById("prof-pic-preview").src = oFREvent.target.result;
               document.getElementById("userpic").src = oFREvent.target.result;
         };
      };
    
      $('#change-prof-pic-upload').click(function(e){
         event.preventDefault();

         if ($('#new-prof-pic')[0].files.length == 0){
            alert("you have not chosen any photo.");
         }
         else{
            var formData = new FormData();
            $img = $('#new-prof-pic')[0].files[0];
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
            formData.append('image', $img);
            $.ajax({
               url: '{% url "docChangeProfPic" %}', 
               type: 'POST',
               data: formData,
               processData: false,
               contentType: false,
               success: function(data) {
                  alert("Change profile photo success.");
               }
            });
         }
         return false;
      });

	
      // statistical data for Patients Handled
      //bar graph
	//all patient
	var other_patients_jan = {{patients_stats.latest.january}};
	var other_patients_feb = {{patients_stats.latest.february}};// + other_patients_jan;
	var other_patients_mar = {{patients_stats.latest.march}};// + other_patients_feb;
	var other_patients_apr = {{patients_stats.latest.april}};// +  other_patients_mar; 
	var other_patients_may = {{patients_stats.latest.may}};// +  other_patients_apr;
	var other_patients_jun = {{patients_stats.latest.june}};// +  other_patients_may;
	var other_patients_jul = {{patients_stats.latest.july}};// +  other_patients_jun;
	var other_patients_aug = {{patients_stats.latest.august}};// +  other_patients_jul;
	var other_patients_sep = {{patients_stats.latest.september}};// +  other_patients_aug;
	var other_patients_oct = {{patients_stats.latest.october}};// +  other_patients_sep;
	var other_patients_nov = {{patients_stats.latest.november}};// +  other_patients_oct;
	var other_patients_dec = {{patients_stats.latest.december}};// +  other_patients_nov;
	

	//doctor patients
	var doc_patients_jan = {{doctor.p_handled_stats.monthly_stats.latest.january}};
        var doc_patients_feb = {{doctor.p_handled_stats.monthly_stats.latest.february}};// + doc_patients_jan;
        var doc_patients_mar = {{doctor.p_handled_stats.monthly_stats.latest.march}};// + doc_patients_feb;
        var doc_patients_apr = {{doctor.p_handled_stats.monthly_stats.latest.april}};// + doc_patients_mar;
        var doc_patients_may = {{doctor.p_handled_stats.monthly_stats.latest.may}};// + doc_patients_apr;
        var doc_patients_jun = {{doctor.p_handled_stats.monthly_stats.latest.june}};// + doc_patients_may;
        var doc_patients_jul = {{doctor.p_handled_stats.monthly_stats.latest.july}};// + doc_patients_jun;
        var doc_patients_aug = {{doctor.p_handled_stats.monthly_stats.latest.august}};// + doc_patients_jul;
        var doc_patients_sep = {{doctor.p_handled_stats.monthly_stats.latest.september}};// + doc_patients_aug;
        var doc_patients_oct = {{doctor.p_handled_stats.monthly_stats.latest.october}};// + doc_patients_sep;
        var doc_patients_nov = {{doctor.p_handled_stats.monthly_stats.latest.november}};// + doc_patients_oct;
        var doc_patients_dec = {{doctor.p_handled_stats.monthly_stats.latest.december}};// + doc_patients_nov;


	//get the total patients per month
	var latest_monthly_patient_count = [other_patients_jan, other_patients_feb, other_patients_mar, other_patients_apr, other_patients_may, other_patients_jun, other_patients_jul,  other_patients_aug, other_patients_sep, other_patients_oct, other_patients_nov, other_patients_dec];
	var all_patients_monthly_count = [doc_patients_jan, doc_patients_feb, doc_patients_mar, doc_patients_apr, doc_patients_may, doc_patients_jun, doc_patients_jul, doc_patients_aug, doc_patients_sep, doc_patients_oct, doc_patients_nov, doc_patients_dec];
	var curr_date = new Date();
	var curr_month = curr_date.getMonth(); //gets the current numeric month 0-based
	let a = 0;


	while (a < curr_month){
		if (a+1 < 13){
			//console.log(a + " before: " +  latest_monthly_patient_count[a]);
			latest_monthly_patient_count[a+1]+=latest_monthly_patient_count[a];
			//console.log(a + " after: " +  latest_monthly_patient_count[a+1]);
			all_patients_monthly_count[a+1]+=all_patients_monthly_count[a];
			console.log(all_patients_monthly_count[a] + " :: " + latest_monthly_patient_count[a]); 
			if (all_patients_monthly_count[a] < latest_monthly_patient_count[a]){
				console.log(a + " before: " + all_patients_monthly_count[a] + " -- " +  latest_monthly_patient_count[a]);
				latest_monthly_patient_count[a]-=all_patients_monthly_count[a];
				console.log(a + " after: " + all_patients_monthly_count[a] + " -- " +  latest_monthly_patient_count[a]);
			}
			a++;
		}
	}

	latest_monthly_patient_count[curr_month]-=all_patients_monthly_count[curr_month];

	window.onload = function() {
         // upon loading,  the latest year's stat  is automatically placed
         var columnChart = new CanvasJS.Chart("chartContainer", {
            animationEnabled: true, 
            height:230,
            width:728,

            axisY:{
               title: 'Number of Patients',
               gridColor: "rgba(1,77,101,.1)",
            },
            axisX:{
               title: 'Year {{doctor.p_handled_stats.monthly_stats.latest.year}}',
               interval: 1
            },
            data: [
            {
               type: "stackedColumn",
               showInLegend: true,
               indexLabel: "{y}",
               indexLabelPlacement: "inside",
               indexLabelFontSize: 15,
               indexLabelFontWeight: "bolder",
               color: "#f27961",
               name: "Your Patients",
               dataPoints: [
                  
                  { label: "January",  y: all_patients_monthly_count[0] },
                  { label: "February", y: all_patients_monthly_count[1] },
                  { label: "March", y: all_patients_monthly_count[2] },
                  { label: "April",  y: all_patients_monthly_count[3] },
                  { label: "May",  y: all_patients_monthly_count[4] },
                  { label: "June",  y: all_patients_monthly_count[5] },
                  { label: "July",  y: all_patients_monthly_count[6] },
                  { label: "August", y: all_patients_monthly_count[7]  },
                  { label: "September", y: all_patients_monthly_count[8]  },
                  { label: "October",  y: all_patients_monthly_count[9] },
                  { label: "November",  y: all_patients_monthly_count[10] },
                  { label: "December",  y: all_patients_monthly_count[11] },
               ]
            },
            {
               type: "stackedColumn",
               showInLegend: true,
               indexLabel: "{y}",
               indexLabelPlacement: "inside",
               indexLabelFontSize: 15,
               indexLabelFontWeight: "bolder",
               name: "Other Patients",
               color: "#20e007", 
               dataPoints: [
                  { label: "January",  y: latest_monthly_patient_count[0]  },
                  { label: "February", y: latest_monthly_patient_count[1] },
                  { label: "March", y: latest_monthly_patient_count[2] },
                  { label: "April",  y: latest_monthly_patient_count[3] },
                  { label: "May",  y: latest_monthly_patient_count[4] },
                  { label: "June",  y: latest_monthly_patient_count[5] },
                  { label: "July",  y: latest_monthly_patient_count[6] },
                  { label: "August",  y: latest_monthly_patient_count[7] },
                  { label: "September",  y: latest_monthly_patient_count[8] },
                  { label: "October",  y: latest_monthly_patient_count[9]},
                  { label: "November",  y: latest_monthly_patient_count[10] },
                  { label: "December",  y:  latest_monthly_patient_count[11] },
               ]
            },
            ]
         });
         columnChart.render();

       	 var for_screening_female = 0;
         var for_screening_male = 0;
         var stage_1_female = 0;
         var stage_1_male = 0;
         var stage_2_female = 0;
         var stage_2_male = 0;
         var stage_3_female = 0;
         var stage_3_male = 0;
       //  var patient_shell;
	 var p_status = "";
	 var p_sex = "";
         {% for p in patients %}
            p_status = "{{p.HIV_status}}";
	    p_sex = "{{p.icr.sex}}";

            if (p_status == "for screening" && p_sex == "female"){
               for_screening_female+=1;
            }else if (p_status == "for screening" && p_sex == "male"){
               for_screening_male+=1;
            }

            if (p_status == "stage 1" && p_sex == "female"){
               stage_1_female+=1;
            }else if (p_status == "stage 1" && p_sex == "male"){
               stage_1_male+=1;
            }

            if (p_status == "stage 2" && p_sex == "female"){
               stage_2_female+=1;
            }else if (p_status == "stage 2" && p_sex == "male"){
               stage_2_male+=1;
            }

            if (p_status == "stage 3" && p_sex == "female"){
               stage_3_female+=1;
            }else if (p_status == "stage 3" && p_sex == "male"){
               stage_3_male+=1;
            }
         {% endfor%}




	{% if doctor.p_handled_stats.doc_patients_count != 0 %}
            var stage1Chart = new CanvasJS.Chart("stage1-patients", {
	    maintainAspectRatio: false,
            responsive:true,
	    animationEnabled: true,
            height: 180,
            width:158,
            data: [
               {
		  type: "pie",
                  showInLegend: true,
                  indexLabel: "{y}",
                  indexLabelPlacement: "inside",
                  indexLabelFontSize: 15,
                  indexLabelFontWeight: "bolder",
                  toolTipContent: "{legendText}: {y}",
                  dataPoints: [
			{  y: stage_1_female, legendText: "female" },
	                {  y: stage_1_male, legendText: "male" },
                  ]
               }
            ]	  
            });

	    showDefaultText(stage1Chart, "No Data Found!");
       	    if (!(stage_1_female==0 && stage_1_male==0) && (stage_1_female == 0 || stage_1_male == 0)){
	    	if (stage1Chart.options.data[0].dataPoints[0].y == 0){
			stage1Chart.options.data[0].dataPoints[0].indexLabel = " ";
	   	 }
	   	 if (stage1Chart.options.data[0].dataPoints[1].y == 0){
           	   	 stage1Chart.options.data[0].dataPoints[1].indexLabel = " ";
           	 }
	    }
	    stage1Chart.render();
	

            var stage2Chart = new CanvasJS.Chart("stage2-patients", {
	    maintainAspectRatio: false,
	    responsive: true,
            animationEnabled: true,
            height: 180,
            width:158,
            data: [
               {
                  type: "pie",
                  showInLegend: true,
                  indexLabel: "{y}",
                  indexLabelPlacement: "inside",
                  indexLabelFontSize: 15,
                  indexLabelFontWeight: "bolder",
                  toolTipContent:  "{legendText}: {y}",                  
                  dataPoints: [
			{  y: stage_2_female, legendText: "female" },
	                {  y: stage_2_male, legendText: "male" },
                  ],
               }
            ]
            });
	    showDefaultText(stage2Chart, "No Data Found!");
            if (!(stage_2_female==0 && stage_2_male==0) && (stage_2_female == 0 || stage_2_male == 0) ){
                if (stage2Chart.options.data[0].dataPoints[0].y == 0){
                        stage2Chart.options.data[0].dataPoints[0].indexLabel = " ";
                 }
                 if (stage2Chart.options.data[0].dataPoints[1].y == 0){
                        stage2Chart.options.data[0].dataPoints[1].indexLabel = " ";
                 }
            }
	    stage2Chart.render();


            var stage3Chart = new CanvasJS.Chart("stage3-patients", {
            responsive: true,
            maintainAspectRatio: false,
            animationEnabled: true,
            height: 180,
            width:158,
            data: [
               {
                  type: "pie",
                  showInLegend: true,
                  indexLabel: "{y}",
                  indexLabelPlacement: "inside",
                  indexLabelFontSize: 15,
                  indexLabelFontWeight: "bolder",
                  toolTipContent: "{legendText}: {y}",

                  dataPoints: [
			{  y: stage_3_female, legendText: "female" },
	                {  y: stage_3_male, legendText: "male" },
                  ]
               }
	    ]            
            });
	    if (!(stage_3_female==0 && stage_3_male==0) && (stage_3_female == 0 || stage_3_male == 0)){
                if (stage3Chart.options.data[0].dataPoints[0].y == 0){
                        stage3Chart.options.data[0].dataPoints[0].indexLabel = " ";
                 }
                 if (stage3Chart.options.data[0].dataPoints[1].y == 0){
                         stage3Chart.options.data[0].dataPoints[1].indexLabel = " ";
                 }
	    }
	    showDefaultText(stage3Chart, "No Data Found!");
            stage3Chart.render();


            var negativePatientChart = new CanvasJS.Chart("for-screening-patients", {
	    maintainAspectRatio: false,
            responsive: true,
            animationEnabled: true,
            height: 180,
            width:158,
            data: [
               {
                  type: "pie",
                  showInLegend: true,
                  indexLabel: "{y}",
                  indexLabelPlacement: "inside",
                  indexLabelFontSize: 15,
                  indexLabelFontWeight: "bolder",
                  toolTipContent: "{legendText}: {y}",
                  dataPoints: [
			{  y: for_screening_female, legendText: "female" },
	                {  y: for_screening_male, legendText: "male" },
                  ]
               }
              ]
            });
	    showDefaultText(negativePatientChart, "No Data Found!");
	      if (!(for_screening_female==0 && for_screening_male==0) && (for_screening_female == 0 || for_screening_male == 0)){
                if (negativePatientChart.options.data[0].dataPoints[0].y == 0){
                        negativePatientChart.options.data[0].dataPoints[0].indexLabel = " ";
                 }
                 if (negativePatientChart.options.data[0].dataPoints[1].y == 0){
                         negativePatientChart.options.data[0].dataPoints[1].indexLabel = " ";
                 }
           }

            negativePatientChart.render();
	{%endif%}


	  function showDefaultText(chart, text){
                var dataPoints = chart.options.data[0].dataPoints;
                var isEmpty = !(dataPoints && dataPoints.length > 0);
		var only1 = false;
                if(!isEmpty){
                        for(var i = 0; i < dataPoints.length; i++){
//				if ((dataPoints[i].y == 0) && (i == 0 || i == 1)){
//					chart.options.data[0].indexLabel = " ";
//                                }
                                isEmpty = dataPoints[i].y;
                                if(isEmpty > 0){ break;}
                        }
                }
		
                if(!chart.options.subtitles)
                        chart.options.subtitles = [];
                if(isEmpty == 0){
			chart.options.data[0].dataPoints = [];
			chart.options.data[0].dataPoints.push({y: "1", legendText: "no patients yet", color: "#008080"});
			chart.options.data[0].showInLegend = true;
			chart.options.data[0].indexLabel = " ";
			chart.options.data[0].indexLabelFontSize = 15;
			chart.options.data[0].indexLabelFontWeight = "bolder";
			chart.options.data[0].indexLabelPlacement = "inside";
			chart.options.data[0].toolTipContent = "{legendText}: 0";
		}

                else
                        chart.options.subtitles = [];
        }


	{% if doctor.p_handled_stats.doc_patients_count == 0 %}
		CanvasJS.addColorSet("greenShades",
        	        [//colorSet Array
               		 "#008080",
               	 	"#2E8B57",
                	"#3CB371",
                	"#90EE90"                
                	]);

         	var noPatient1Chart = new CanvasJS.Chart("no-patients1", {
            	colorSet: "greenShades",
		maintainAspectRatio: false,
                responsive: true,

            	animationEnabled: true,
            	height: 180,
            	width:158,
            	data: [
               	{
	        	type: "pie",
                  	showInLegend: true,
                  	indexLabel: "0",
                 	// indexLabelPlacement: "inside",
                 	// indexLabelFontSize: 15,
                 	// indexLabelFontWeight: "bolder",
                  	toolTipContent: "{legendText}: 0",                  
                  	dataPoints: [
                  	{  y:'1', legendText: "No Patients yet" },
                  	],
               
               	}
            	]
            });
            noPatient1Chart.render();
	
	    var noPatient2Chart = new CanvasJS.Chart("no-patients2", {
               colorSet: "greenShades",
               responsive:true,
	       maintainAspectRatio: false,
               animationEnabled: true,
               height: 180,
               width:158,
               data: [
                  {
                     type: "pie",
                     showInLegend: true,
                     indexLabel: "0",
                     //indexLabelPlacement: "inside",
                     //indexLabelFontSize: 15,
                     //indexLabelFontWeight: "bolder",
                     toolTipContent: "{legendText}: 0",
                     
                     dataPoints: [
                     {  y:'1', legendText: "No Patients yet" },
                     ],
                  
                  }
               ]
            });
            noPatient2Chart.render();

            var noPatient3Chart = new CanvasJS.Chart("no-patients3", {
               colorSet: "greenShades",
               responsive:true,
               maintainAspectRatio: false,
               animationEnabled: true,
               height: 180,
               width:158,
               data: [
                  {
                     type: "pie",
                     showInLegend: true,
                     indexLabel: "0",
                     //indexLabelPlacement: "inside",
                     //indexLabelFontSize: 15,
                     //indexLabelFontWeight: "bolder",
                     toolTipContent: "{legendText}: 0",
                     
                     dataPoints: [
                     {  y:'1', legendText: "No Patients yet" },
                     ],
                  
                  }
               ]
            });
            noPatient3Chart.render();

            var noPatient4Chart = new CanvasJS.Chart("no-patients4", {
               colorSet: "greenShades",
               responsive:true,
               maintainAspectRatio: false,
               animationEnabled: true,
               height: 180,
               width:158,
               data: [
                  {
                     type: "pie",
                     showInLegend: true,
                     indexLabel: "0",
                     //indexLabelPlacement: "inside",
                     //indexLabelFontSize: 15,
                     //indexLabelFontWeight: "bolder",
                     toolTipContent: "{legendText}: 0",
                     
                     dataPoints: [
                     {  y:'1', legendText: "No Patients yet" },
                     ],
                  
                  }
               ]
            });
            noPatient4Chart.render();

	{% endif %}

         function explodePie(e) {
            for(var i = 0; i < e.dataSeries.dataPoints.length; i++) {
               if(i !== e.dataPointIndex)
                  e.dataSeries.dataPoints[i].exploded = false;
            }
         }

            // set the data to be downloaded //get it ready just in case, it will be downloaded
         $("#stat-label").text("{{doctor.p_handled_stats.monthly_stats.latest.year}})");
         $("#d-jan").text(all_patients_monthly_count[0]);
         $("#d-feb").text(all_patients_monthly_count[1]);
         $("#d-mar").text(all_patients_monthly_count[2]);
         $("#d-apr").text(all_patients_monthly_count[3]);
         $("#d-may").text(all_patients_monthly_count[4]);
         $("#d-jun").text(all_patients_monthly_count[5]);
         $("#d-jul").text(all_patients_monthly_count[6]);
         $("#d-aug").text(all_patients_monthly_count[7]);
         $("#d-sep").text(all_patients_monthly_count[8]);
         $("#d-oct").text(all_patients_monthly_count[9]);
         $("#d-nov").text(all_patients_monthly_count[10]);
         $("#d-dec").text(all_patients_monthly_count[11]);
      }         
               

   </script>
{% endblock content %}
